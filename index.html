
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>バス報告（売上・在庫・カレンダー）</title>
  <style>
    :root { --b:#ddd; --bg:#fff; --muted:#666; --ok:#0a7; --ng:#c22; }
    body{ font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif; margin:14px; line-height:1.35; background:#fafafa; color:#111; }
    h1{font-size:18px;margin:0 0 10px;}
    h2{font-size:15px;margin:0 0 8px;}
    .card{background:var(--bg);border:1px solid var(--b);border-radius:12px;padding:12px;margin:12px 0;}
    label{display:block;font-size:12px;margin-top:10px;color:#222;}
    input,select,textarea,button{ width:100%;font-size:16px;padding:10px;border-radius:10px;border:1px solid #ccc;box-sizing:border-box;background:#fff; }
    textarea{min-height:110px;}
    button{background:#0a7;color:#fff;border:none;cursor:pointer;}
    button.sub{background:#555;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    .btnrow2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .btnrow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;}
    .small{font-size:12px;color:var(--muted);}
    .status{font-size:12px;margin-top:8px;}
    .ok{color:var(--ok);}
    .ng{color:var(--ng);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Mono","Segoe UI Mono",monospace;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left;vertical-align:middle;}
    th{color:#333;font-weight:600;}
    .warn{color:var(--ng);font-size:12px;margin-top:6px;}
    .stickyWrap{overflow:auto;border:1px solid #eee;border-radius:12px;background:#fff;}
    .matrix{min-width: 920px;}
    .matrix th{position: sticky;top: 0;background: #fff;z-index: 1;}
    .matrix td:first-child, .matrix th:first-child{position: sticky;left: 0;background: #fff;z-index: 2;}
    .cellNum{width: 92px;padding: 8px;font-size: 16px;border-radius: 10px;}
    .rowTag{white-space:nowrap;}
    .divider{height:1px;background:#eee;margin:12px 0;}

    /* Calendar */
    .calGrid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .calDow{ font-size:12px;color:var(--muted); text-align:center; }
    .calCell{ background:#fff;border:1px solid #eee;border-radius:12px; padding:10px; min-height:72px; }
    .calCell button{ width:100%; background:transparent; color:#111; border:none; padding:0; cursor:pointer; text-align:left; }
    .calDate{ font-weight:700;font-size:14px; }
    .calMoney{ margin-top:6px; font-size:12px; color:#0a7; }
    .calEmpty{ background:transparent;border:none; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal[aria-hidden="false"]{ display:flex; }
    .modalInner{ width:min(520px, 100%); background:#fff; border-radius:14px; padding:12px; border:1px solid #ddd; max-height:80vh; overflow:auto; -webkit-overflow-scrolling:touch;}
    .modalHead{ display:flex; align-items:center; justify-content:space-between; gap:12px; }

    /* iPhone: 入力時ズーム防止 */
    input, select, textarea{ font-size:16px; }

    /* Mobile：レイアウト */
    @media (max-width:520px){
      body{ margin:10px; }
      .grid3,.grid2,.btnrow3,.btnrow2{ grid-template-columns:1fr !important; }
      .matrix th{ position: static !important; }
      .matrix td:first-child, .matrix th:first-child{ position: static !important; }
      .stickyWrap{ -webkit-overflow-scrolling: touch; }

      /* ここから：スマホは“列タブ”で1列入力 */
      #mobileColTabs, #mobileColHint{ display:block !important; }
      .matrix th:not(:first-child), .matrix td:not(:first-child){ display:none; }
      body.show-credit .matrix th.col-credit, body.show-credit .matrix td.col-credit{ display:table-cell; }
      body.show-cash   .matrix th.col-cash,   body.show-cash   .matrix td.col-cash{ display:table-cell; }
      body.show-klook  .matrix th.col-klook,  body.show-klook  .matrix td.col-klook{ display:table-cell; }
      body.show-nutsmeg .matrix th.col-nutsmeg, body.show-nutsmeg .matrix td.col-nutsmeg{ display:table-cell; }
      body.show-kansai .matrix th.col-kansai, body.show-kansai .matrix td.col-kansai{ display:table-cell; }
      body.show-ic     .matrix th.col-ic,     body.show-ic     .matrix td.col-ic{ display:table-cell; }
      .cellNum{ width:100% !important; font-size:18px !important; padding:12px !important; }
    }
  </style>
</head>

<body>
  <h1>バス報告（売上・在庫・カレンダー）</h1>

  <div class="card">
    <h2>① 基本情報</h2>
    <div class="grid3">
      <div>
        <label>日付</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>バス（A/B）</label>
        <select id="bus">
          <option value="A">バスA</option>
          <option value="B">バスB</option>
        </select>
      </div>
      <div>
        <label>天気（大阪 自動取得）</label>
        <select id="weather">
          <option value="">（未入力）</option>
          <option value="晴れ">晴れ</option>
          <option value="くもり">くもり</option>
          <option value="雨">雨</option>
        </select>
        <div id="wxStatus" class="small"></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <label id="leader1Label">A1（入力）</label>
        <input id="leader1" type="text" placeholder="例：ジョージ" />
      </div>
      <div>
        <label id="leader2Label">A2（入力・保存される）</label>
        <input id="leader2" type="text" placeholder="例：ジョージ" />
        <div class="small">※A2 / B2 は端末に保存されます</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>② 前日在庫（LINE文ペースト or 自動取得）</h2>
    <textarea id="prevPaste" class="mono" placeholder="前日の在庫メッセージを丸ごとペースト"></textarea>
    <div class="btnrow2">
      <button id="parseBtn">パース（読み取り）</button>
      <button id="fetchPrevBtn" class="sub">前回在庫を自動取得</button>
    </div>
    <div id="parseStatus" class="status small"></div>
    <div id="fetchStatus" class="status small"></div>

    <div style="margin-top:10px;">
      <table>
        <thead><tr><th>券種</th><th>前日在庫</th><th>今日売上</th><th>今日在庫</th></tr></thead>
        <tbody id="invTable"></tbody>
      </table>
      <div id="invWarn" class="warn"></div>
    </div>
  </div>

  <div class="card">
    <h2>③ 売上入力（表）</h2>
    <div class="small">列：クレ / 現金 / Klook / ナツメグ / 関西 / IC（未入力=0）</div>

    <!-- スマホ用：入力列切替 -->
    <div id="mobileColTabs" class="btnrow3" style="display:none; margin-top:10px;">
      <button type="button" class="sub" data-col="credit">クレ</button>
      <button type="button" class="sub" data-col="cash">現金</button>
      <button type="button" class="sub" data-col="klook">Klook</button>
      <button type="button" class="sub" data-col="nutsmeg">ナツメグ</button>
      <button type="button" class="sub" data-col="kansai">関西</button>
      <button type="button" class="sub" data-col="ic">IC</button>
    </div>
    <div id="mobileColHint" class="small" style="display:none;">スマホは列をタブで切り替えて入力（見やすさ優先）</div>

    <div class="stickyWrap" style="margin-top:10px;">
      <table class="matrix" id="salesMatrix">
        <thead>
          <tr>
            <th>項目</th>
            <th class="col-credit">クレジット</th>
            <th class="col-cash">現金</th>
            <th class="col-klook">Klook</th>
            <th class="col-nutsmeg">ナツメグ</th>
            <th class="col-kansai">関西パス</th>
            <th class="col-ic">交通系IC</th>
          </tr>
        </thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>

    <div class="divider"></div>
    <div class="grid3">
      <div><label>税率（%）</label><input id="taxRate" type="number" min="0" step="0.1" value="10" inputmode="decimal" /></div>
      <div><label>売上（税込）</label><input id="salesIn" type="text" readonly /></div>
      <div><label>売上（税別）</label><input id="salesEx" type="text" readonly /></div>
    </div>
    <div class="grid3">
      <div><label>現金合計</label><input id="cashSum" type="text" readonly /></div>
      <div><label>クレ合計</label><input id="creditSum" type="text" readonly /></div>
      <div><label>IC合計</label><input id="icSum" type="text" readonly /></div>
    </div>
    <div class="grid3">
      <div><label>関西合計</label><input id="kansaiSum" type="text" readonly /></div>
      <div><label>Klook枚数</label><input id="klookCount" type="text" readonly /></div>
      <div><label>ナツメグ枚数</label><input id="nutsmegCount" type="text" readonly /></div>
    </div>
  </div>

  <div class="card">
    <h2>⑤ 出力</h2>
    <div class="btnrow3">
      <button id="genInv">在庫文</button>
      <button id="genSales">売上文</button>
      <button id="genAll">全部生成</button>
    </div>

    <div class="btnrow3">
      <button id="saveToSheet" class="sub">スプレッドシートに保存</button>
      <button id="copy" class="sub">コピー</button>
      <button id="reloadCal" class="sub">カレンダー更新</button>
    </div>

    <div id="saveStatus" class="status small"></div>
    <div id="copyStatus" class="status ok" style="display:none;">コピーしました</div>

    <textarea id="out" class="mono" readonly></textarea>

    <!-- CORS回避：フォーム送信用 -->
    <iframe id="saveFrame" name="saveFrame" style="display:none;"></iframe>
    <form id="saveForm" method="POST" target="saveFrame" style="display:none;">
      <input type="hidden" name="payload" id="payloadField" />
    </form>
  </div>

  <div class="card">
    <h2>⑥ 履歴カレンダー</h2>
    <div class="grid3">
      <div>
        <label>表示バス</label>
        <select id="calBus">
          <option value="A">A</option>
          <option value="B">B</option>
        </select>
      </div>
      <div>
        <label>表示月</label>
        <div class="grid2">
          <button id="prevMonth" class="sub">◀ 前月</button>
          <button id="nextMonth" class="sub">次月 ▶</button>
        </div>
        <div id="monthTitle" class="small" style="margin-top:6px;"></div>
      </div>
      <div>
        <label>状態</label>
        <div id="calStatus" class="status small"></div>
      </div>
    </div>

    <div class="divider"></div>
    <div class="calGrid" id="calGrid"></div>

    <div class="modal" id="dayModal" aria-hidden="true">
      <div class="modalInner">
        <div class="modalHead">
          <div id="dayModalTitle" style="font-weight:700;"></div>
          <button id="closeModal" class="sub" style="width:auto;padding:8px 10px;">閉じる</button>
        </div>
        <div id="dayModalBody" class="small"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ★必ず /exec を貼る
  const GAS_URL = "PASTE_YOUR_GAS_EXEC_URL_HERE";

  // ===== JSONP（CORS回避）=====
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data)=>{ cleanup(); resolve(data); };
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cb + "&t=" + Date.now();
      s.onerror = ()=>{ cleanup(); reject(new Error("jsonp_error")); };
      document.head.appendChild(s);
      function cleanup(){
        try{ delete window[cb]; }catch{}
        if(s.parentNode) s.parentNode.removeChild(s);
      }
    });
  }
  function apiUrl(params){
    const u = new URL(GAS_URL);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
    return u.toString();
  }

  // ===== LocalStorage =====
  const LS = {
    A2:"bus_report_A2", B2:"bus_report_B2", lastBus:"bus_report_lastBus",
    clientId:"bus_report_client_id",
    weather:"bus_report_weather"
  };

  // ===== 天気（大阪 自動取得）=====
  // Open-Meteo (大阪市付近)
  const OSAKA = { lat: 34.6937, lon: 135.5023 };
  function mapWeatherCodeToJP(code){
    // Open-Meteo weathercode
    // 0:晴れ, 1-3:雲, 45-48:霧(くもり扱い), 51-67:雨系, 71-77:雪(くもり扱い), 80-82:にわか雨, 95-99:雷雨(雨扱い)
    if(code === 0) return "晴れ";
    if((code>=1 && code<=3) || (code>=45 && code<=48)) return "くもり";
    if((code>=51 && code<=67) || (code>=80 && code<=82) || (code>=95 && code<=99)) return "雨";
    // それ以外は安全にくもり
    return "くもり";
  }
  async function autoWeatherOsaka(){
    const st = $("wxStatus");
    st.textContent = "天気取得中…";
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${OSAKA.lat}&longitude=${OSAKA.lon}&current_weather=true&timezone=Asia%2FTokyo`;
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("wx_http");
      const data = await res.json();
      const code = data?.current_weather?.weathercode;
      if(typeof code !== "number") throw new Error("wx_no_code");
      const jp = mapWeatherCodeToJP(code);
      $("weather").value = jp;
      try{ localStorage.setItem(LS.weather, jp); }catch{}
      st.textContent = `大阪: ${jp}（自動）`;
    }catch(e){
      // 失敗時は前回値を復元
      try{
        const w = localStorage.getItem(LS.weather);
        if(w) $("weather").value = w;
      }catch{}
      st.textContent = "天気取得失敗（手動/前回値で対応）";
    }
  }

  // ===== Master =====
  const TICKETS = [
    { key:"t1",  no:"①", label:"OCP 1 DAY",              channel:"OCP1day（大人）" },
    { key:"t2",  no:"②", label:"OCP 2 DAY",              channel:"OCP2day（大人）" },
    { key:"t3",  no:"③", label:"バスのみ1DAY",          channel:"バスのみ1DAY（大人）" },
    { key:"t4",  no:"④", label:"バスのみ2DAY",          channel:"バスのみ2DAY（大人）" },
    { key:"t5",  no:"⑤", label:"クルーズのみ",          channel:"クルーズのみ（大人）" },
    { key:"t6",  no:"⑥", label:"OCP1day（子供）",       channel:"OCP1day（子供）" },
    { key:"t7",  no:"⑦", label:"OCP2day（子供）",       channel:"OCP2day（子供）" },
    { key:"t8",  no:"⑧", label:"バスのみ1DAY（子供）",  channel:"バスのみ1DAY（子供）" },
    { key:"t9",  no:"⑨", label:"バスのみ2DAY（子供）",  channel:"バスのみ2DAY（子供）" },
    { key:"t10", no:"⑩", label:"クルーズのみ（子供）",  channel:"クルーズのみ（子供）" },
  ];
  const GOODS = [
    { key:"g_water", label:"水", price:200, outLine:(n)=>`水x${n}本` },
    { key:"g_umb",   label:"傘", price:500, outLine:(n)=>`傘 × ${n}本` },
    { key:"g_kairo", label:"カイロ", price:100, outLine:(n)=>`カイロx${n}枚` },
  ];
  const COLS = [
    { key:"credit", label:"クレジット", money:true },
    { key:"cash",   label:"現金", money:true },
    { key:"klook",  label:"Klook", money:false },
    { key:"nutsmeg",label:"ナツメグ", money:false },
    { key:"kansai", label:"関西パス", money:true },
    { key:"ic",     label:"交通系IC", money:true },
  ];

  const PRICE = { t1:6000,t2:8200,t3:4400,t4:6600,t5:2000,t6:3300,t7:4400,t8:2200,t9:3300,t10:800, g_water:200,g_umb:500,g_kairo:100 };
  function unitPrice(rowKey, colKey){
    if(colKey==="kansai" && rowKey==="t3") return 2500;
    if(colKey==="kansai" && rowKey==="t8") return 1500;
    return PRICE[rowKey] ?? 0;
  }

  const ALL_ROWS = [
    ...TICKETS.map(t=>({key:t.key,label:`${t.no}${t.label}`})),
    ...GOODS.map(g=>({key:g.key,label:g.label}))
  ];

  // ===== State =====
  let prevInv = Object.fromEntries(TICKETS.map(t=>[t.key,0]));
  let counts = {};
  function initCounts(){
    counts = {};
    for(const r of ALL_ROWS){
      counts[r.key] = {};
      for(const c of COLS) counts[r.key][c.key] = 0;
    }
  }
  function toInt(v){
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) && n > 0 ? Math.floor(n) : 0;
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function jpWeekday(d){ return ["日","月","火","水","木","金","土"][d.getDay()]; }
  function dateFromInput(){ return new Date(($("date").value || new Date().toISOString().slice(0,10)) + "T00:00:00"); }
  function fmtStock(d){ return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}(${jpWeekday(d)})`; }
  function fmtSales(d){ return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日(${jpWeekday(d)})`; }

  function leaderLine(){
    const bus = $("bus").value;
    const l1 = ($("leader1").value || "").trim() || "（未入力）";
    const l2 = ($("leader2").value || "").trim() || "（未入力）";
    return bus==="A" ? `担当: A1${l1}、 A2${l2}` : `担当: B1${l1}、 B2${l2}`;
  }

  function soldCountForTicket(ticketKey){
    let s = 0;
    for(const c of COLS) s += (counts[ticketKey]?.[c.key] ?? 0);
    return s;
  }
  function todayInvFor(t){
    const p = prevInv[t.key] ?? 0;
    const s = soldCountForTicket(t.key);
    const raw = p - s;
    return raw >= 0 ? raw : 0;
  }

  function moneyTotals(){
    let credit=0,cash=0,kansai=0,ic=0,gross=0;
    let klookCount=0,nutsmegCount=0;

    for(const r of ALL_ROWS){
      klookCount += (counts[r.key]?.klook ?? 0);
      nutsmegCount += (counts[r.key]?.nutsmeg ?? 0);

      for(const colKey of ["credit","cash","kansai","ic"]){
        const n = counts[r.key]?.[colKey] ?? 0;
        if(n<=0) continue;
        const unit = unitPrice(r.key, colKey);
        const amt = n * unit;
        gross += amt;
        if(colKey==="credit") credit += amt;
        if(colKey==="cash") cash += amt;
        if(colKey==="kansai") kansai += amt;
        if(colKey==="ic") ic += amt;
      }
    }
    return {credit,cash,kansai,ic,gross,klookCount,nutsmegCount};
  }

  function recompute(){
    const t = moneyTotals();
    const rate = Number($("taxRate").value || 10)/100;
    const ex = Math.round(t.gross/(1+rate));

    $("salesIn").value = `${t.gross.toLocaleString()}円`;
    $("salesEx").value = `${ex.toLocaleString()}円`;
    $("cashSum").value = `${t.cash.toLocaleString()}円`;
    $("creditSum").value = `${t.credit.toLocaleString()}円`;
    $("icSum").value = `${t.ic.toLocaleString()}円`;
    $("kansaiSum").value = `${t.kansai.toLocaleString()}円`;
    $("klookCount").value = `${t.klookCount}枚`;
    $("nutsmegCount").value = `${t.nutsmegCount}枚`;
  }

  function renderInvTable(){
    const tbody = $("invTable");
    tbody.innerHTML = "";
    const warn = [];
    for(const t of TICKETS){
      const p = prevInv[t.key] ?? 0;
      const s = soldCountForTicket(t.key);
      const ti = todayInvFor(t);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.no} ${t.label}</td><td>${p}</td><td>${s}</td><td>${ti}</td>`;
      tbody.appendChild(tr);
      if(s>p) warn.push(`${t.no}（売上${s}が前日在庫${p}を超過）`);
    }
    $("invWarn").textContent = warn.length ? ("警告: " + warn.join(" / ") + "（今日在庫は0に丸めました）") : "";
  }

  function buildMatrix(){
    const tb = $("matrixBody");
    tb.innerHTML = "";
    for(const r of ALL_ROWS){
      const tr = document.createElement("tr");
      const first = document.createElement("td");
      first.className = "rowTag";
      first.textContent = r.label;
      tr.appendChild(first);

      for(const c of COLS){
        const td = document.createElement("td");
        td.classList.add("col-" + c.key); // ★スマホ列タブ用

        const inp = document.createElement("input");
        inp.className = "cellNum";
        inp.type = "number";
        inp.min = "0";
        inp.inputMode = "numeric";
        inp.value = "0";
        inp.addEventListener("input", ()=>{
          counts[r.key][c.key] = toInt(inp.value);
          recompute();
          renderInvTable();
        });
        td.appendChild(inp);
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
  }

  // スマホ：列タブ
  function setMobileCol(col){
    document.body.classList.remove("show-credit","show-cash","show-klook","show-nutsmeg","show-kansai","show-ic");
    document.body.classList.add("show-" + col);
  }
  function initMobileTabs(){
    const tabs = document.getElementById("mobileColTabs");
    if(!tabs) return;
    setMobileCol("cash");
    tabs.querySelectorAll("button[data-col]").forEach(btn=>{
      btn.addEventListener("click", ()=>setMobileCol(btn.dataset.col));
    });
  }

  function buildStockMessage(d){
    const bus = $("bus").value;
    const lines = [];
    lines.push(`${fmtStock(d)}チケット在庫`);
    lines.push(`バス${bus}`);
    lines.push("");
    for(const t of TICKETS){
      lines.push(`${t.no}${t.label}→${todayInvFor(t)}`);
    }
    lines.push("");
    lines.push(leaderLine());
    return lines.join("\n");
  }

  function buildChannelLinesFor(key){
    const lines = [];
    for(const t of TICKETS){
      const v = counts[t.key]?.[key] ?? 0;
      if(v>0) lines.push(`${t.channel}${v}名`);
    }
    return lines;
  }

  function goodsLinesFromMatrix(){
    const out = [];
    for(const g of GOODS){
      const total = COLS.reduce((a,c)=>a + (counts[g.key]?.[c.key] ?? 0), 0);
      if(total>0) out.push(g.outLine(total));
    }
    return out;
  }

  function buildSalesMessage(d){
    const bus = $("bus").value;
    const weather = $("weather").value || "（未入力）";
    const t = moneyTotals();
    const rate = Number($("taxRate").value || 10)/100;
    const ex = Math.round(t.gross/(1+rate));

    const lines = [];
    lines.push(`${fmtSales(d)}`);
    lines.push(`バス${bus}`);
    lines.push(leaderLine());
    lines.push(`天気: ${weather}`);
    lines.push("");
    lines.push(`売上 ${ex.toLocaleString()}円（税別）`);
    lines.push(`   ${t.gross.toLocaleString()}円（税込）`);
    lines.push("");
    lines.push(`【現金合計】${t.cash.toLocaleString()}円`);
    lines.push(`【クレジット合計】${t.credit.toLocaleString()}円`);
    lines.push(`【交通系合計】${t.ic.toLocaleString()}円`);
    lines.push(`【関西パス合計】${t.kansai.toLocaleString()}円`);
    lines.push(`【klook】`);
    lines.push(...buildChannelLinesFor("klook"));
    lines.push(`【ナツメグ】`);
    lines.push(...buildChannelLinesFor("nutsmeg"));
    lines.push(`【関西パス】`);
    lines.push(...buildChannelLinesFor("kansai"));

    const goods = goodsLinesFromMatrix();
    if(goods.length){ lines.push(""); lines.push(...goods); }
    return lines.join("\n");
  }

  function buildClientId(){
    try{
      let id = localStorage.getItem(LS.clientId);
      if(!id){
        id = "c_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem(LS.clientId, id);
      }
      return id;
    }catch{ return ""; }
  }

  function buildPayloadForSave(){
    const date = $("date").value;
    const bus = $("bus").value;
    const totals = moneyTotals();
    const rate = Number($("taxRate").value || 10)/100;
    const ex = Math.round(totals.gross/(1+rate));

    const invObj = {};
    for(const t of TICKETS){
      invObj[t.key] = { prev: prevInv[t.key] ?? 0, sold: soldCountForTicket(t.key), today: todayInvFor(t) };
    }

    const matrixObj = {};
    for(const r of ALL_ROWS){
      matrixObj[r.key] = {};
      for(const c of COLS) matrixObj[r.key][c.key] = counts[r.key]?.[c.key] ?? 0;
    }

    return {
      action:"saveReport",
      date, bus,
      meta:{
        weather: $("weather").value || "",
        leader1: ($("leader1").value || "").trim(),
        leader2: ($("leader2").value || "").trim(),
        loadText:"",
        outAll: $("out").value || "",
        clientId: buildClientId()
      },
      totals:{
        gross: totals.gross||0, ex,
        cash: totals.cash||0, credit: totals.credit||0, ic: totals.ic||0, kansai: totals.kansai||0,
        klookCount: totals.klookCount||0, nutsmegCount: totals.nutsmegCount||0
      },
      inv: invObj,
      matrix: matrixObj
    };
  }

  // 保存：CORS回避（フォーム送信）
  function saveToSheet(){
    const st = $("saveStatus");
    if(st) st.textContent = "送信中…";

    if(!($("out").value||"").trim()) $("genAll").click();

    const payload = JSON.stringify(buildPayloadForSave());
    $("payloadField").value = payload;

    const form = $("saveForm");
    form.action = GAS_URL;
    form.submit();

    setTimeout(()=>{ if(st) st.textContent = "送信しました（カレンダー更新で反映確認）"; }, 600);
  }

  // 前日在庫パース
  function parsePrevText(text){
    const res = { ok:true, missing:[], inv:{} };
    const arrow = "(?:→|⇒|➔|->|＞)";
    for(const t of TICKETS){
      const sym = t.no.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const re = new RegExp(sym + "[^\\n\\r]*?" + arrow + "\\s*(\\d+)", "i");
      const m = text.match(re);
      if(!m){ res.ok=false; res.missing.push(t.no); res.inv[t.key]=0; }
      else res.inv[t.key]=toInt(m[1]);
    }
    return res;
  }

  // 前回在庫：JSONP
  async function fetchPrevInventory(){
    const st = $("fetchStatus");
    st.textContent = "取得中…";
    try{
      const date = $("date").value;
      const bus = $("bus").value;
      const data = await jsonp(apiUrl({action:"getPrev", date, bus}));
      if(!data.ok){ st.textContent = "失敗: " + (data.error||"unknown"); return; }
      if(!data.found){ st.textContent = "見つかりません（ペーストで対応）"; return; }
      prevInv = data.inv || prevInv;
      renderInvTable();
      st.textContent = `取得成功（${data.source_date} / バス${data.bus}）`;
    }catch(e){
      st.textContent = "通信エラー（JSONP）";
    }
  }

  // ===== Calendar =====
  const DOW = ["日","月","火","水","木","金","土"];
  let calYear, calMonth; // 1-12
  function ymd(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function openModal(title, html){
    $("dayModalTitle").textContent = title;
    $("dayModalBody").innerHTML = html;
    $("dayModal").setAttribute("aria-hidden","false");
  }
  function closeModal(){ $("dayModal").setAttribute("aria-hidden","true"); }

  function renderDow(){
    const grid = $("calGrid");
    grid.innerHTML = "";
    for(const w of DOW){
      const div = document.createElement("div");
      div.className = "calDow";
      div.textContent = w;
      grid.appendChild(div);
    }
  }

  function buildCalendarGrid(year, month, bus, dayToGross){
    renderDow();
    const grid = $("calGrid");
    const first = new Date(year, month-1, 1);
    const last  = new Date(year, month, 0);
    const firstDow = first.getDay();
    const lastDate = last.getDate();

    for(let i=0;i<firstDow;i++){
      const div = document.createElement("div");
      div.className = "calCell calEmpty";
      grid.appendChild(div);
    }

    for(let d=1; d<=lastDate; d++){
      const dateStr = ymd(year, month, d);
      const gross = Number(dayToGross?.[dateStr] ?? 0);

      const cell = document.createElement("div");
      cell.className = "calCell";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.addEventListener("click", ()=> loadDayDetail(dateStr, bus));

      const top = document.createElement("div");
      top.className = "calDate";
      top.textContent = String(d);
      btn.appendChild(top);

      if(gross > 0){
        const money = document.createElement("div");
        money.className = "calMoney";
        money.textContent = `売上: ¥${gross.toLocaleString()}`;
        btn.appendChild(money);
      }else{
        const s = document.createElement("div");
        s.className = "small";
        s.style.marginTop = "6px";
        s.textContent = "データなし";
        btn.appendChild(s);
      }

      cell.appendChild(btn);
      grid.appendChild(cell);
    }
  }

  async function loadCalendar(){
    const st = $("calStatus");
    st.textContent = "読み込み中…";
    try{
      // pingでGAS公開チェック（失敗なら原因が分かりやすい）
      await jsonp(apiUrl({action:"ping"}));

      const bus = $("calBus").value;
      const year = calYear;
      const month = pad2(calMonth);
      $("monthTitle").textContent = `${year}年 ${calMonth}月（バス${bus}）`;

      const data = await jsonp(apiUrl({action:"getMonth", year:String(year), month, bus}));
      if(!data.ok){ st.textContent = "失敗: " + (data.error||"unknown"); return; }
      buildCalendarGrid(year, calMonth, bus, data.days || {});
      st.textContent = "OK（日付タップで詳細）";
    }catch(e){
      st.textContent = "通信エラー（JSONP） ※GAS公開/URLを確認";
    }
  }

  async function loadDayDetail(dateStr, bus){
    openModal(`${dateStr}（バス${bus}）`, "読み込み中…");
    try{
      const data = await jsonp(apiUrl({action:"getDay", date:dateStr, bus}));
      if(!data.ok){ openModal(`${dateStr}（バス${bus}）`, "失敗: " + (data.error||"unknown")); return; }
      if(!data.found || !data.report){ openModal(`${dateStr}（バス${bus}）`, "この日付のレポートがありません。"); return; }

      const r = data.report;
      const inv = data.inventory || {};
      const keys = Object.keys(inv).sort();
      const invHtml = keys.length
        ? `<table><thead><tr><th>ticket_key</th><th>残数</th></tr></thead><tbody>${
            keys.map(k=>`<tr><td>${escapeHtml(k)}</td><td>${Number(inv[k]||0)}</td></tr>`).join("")
          }</tbody></table>`
        : `<div class="small">在庫データなし</div>`;

      const html = `
        <div class="small">
          <div><b>天気</b>: ${escapeHtml(r.weather||"")}</div>
          <div><b>リーダー</b>: ${escapeHtml(r.leader1||"")} / ${escapeHtml(r.leader2||"")}</div>
          <div class="divider"></div>
          <div><b>売上（税込）</b>: ¥${Number(r.gross||0).toLocaleString()}</div>
          <div><b>現金</b>: ¥${Number(r.cash||0).toLocaleString()}</div>
          <div><b>クレ</b>: ¥${Number(r.credit||0).toLocaleString()}</div>
          <div><b>IC</b>: ¥${Number(r.ic||0).toLocaleString()}</div>
          <div><b>関西</b>: ¥${Number(r.kansai||0).toLocaleString()}</div>
          <div><b>Klook</b>: ${Number(r.klookCount||0)} 件</div>
          <div><b>Nutsmeg</b>: ${Number(r.nutsmegCount||0)} 件</div>
          <div class="divider"></div>
          <div style="font-weight:700;">在庫（今日残）</div>
          ${invHtml}
        </div>
      `;
      openModal(`${dateStr}（バス${bus}）`, html);
    }catch(e){
      openModal(`${dateStr}（バス${bus}）`, "通信エラー（JSONP）");
    }
  }

  // ===== UI actions =====
  $("parseBtn").addEventListener("click",(e)=>{
    e.preventDefault();
    const text = $("prevPaste").value || "";
    const parsed = parsePrevText(text);
    prevInv = Object.fromEntries(TICKETS.map(t=>[t.key, parsed.inv[t.key] ?? 0]));
    $("parseStatus").innerHTML = parsed.ok ? `<span class="ok">パース成功</span>` : `<span class="ng">一部失敗: ${parsed.missing.join(" ")}</span>`;
    renderInvTable();
  });

  $("fetchPrevBtn").addEventListener("click",(e)=>{ e.preventDefault(); fetchPrevInventory(); });

  $("genInv").addEventListener("click",(e)=>{ e.preventDefault(); $("out").value = buildStockMessage(dateFromInput()); });
  $("genSales").addEventListener("click",(e)=>{ e.preventDefault(); $("out").value = buildSalesMessage(dateFromInput()); });
  $("genAll").addEventListener("click",(e)=>{ e.preventDefault(); const d=dateFromInput(); $("out").value = buildStockMessage(d) + "\n\n" + buildSalesMessage(d); });

  $("copy").addEventListener("click", async (e)=>{
    e.preventDefault();
    if(!($("out").value||"").trim()) $("genAll").click();
    try{
      await navigator.clipboard.writeText($("out").value);
      $("copyStatus").style.display="block";
      setTimeout(()=>$("copyStatus").style.display="none", 1200);
    }catch{ alert("コピーに失敗しました。"); }
  });

  $("saveToSheet").addEventListener("click",(e)=>{ e.preventDefault(); saveToSheet(); });

  $("reloadCal").addEventListener("click",(e)=>{ e.preventDefault(); loadCalendar(); }); // ★これが抜けると更新できない

  $("taxRate").addEventListener("input", ()=>recompute());

  $("bus").addEventListener("change", ()=>{
    const bus = $("bus").value;
    $("leader1Label").textContent = bus==="A" ? "A1（入力）" : "B1（入力）";
    $("leader2Label").textContent = bus==="A" ? "A2（入力・保存される）" : "B2（入力・保存される）";
    try{ localStorage.setItem(LS.lastBus, bus); }catch{}
    try{
      $("leader2").value = (bus==="A" ? localStorage.getItem(LS.A2) : localStorage.getItem(LS.B2)) || $("leader2").value;
    }catch{}
    $("calBus").value = bus;
  });

  $("leader2").addEventListener("input", ()=>{
    const bus = $("bus").value;
    const v = ($("leader2").value||"").trim();
    try{ if(bus==="A") localStorage.setItem(LS.A2,v); else localStorage.setItem(LS.B2,v); }catch{}
  });

  // Calendar controls
  $("prevMonth").addEventListener("click",(e)=>{ e.preventDefault(); calMonth--; if(calMonth<=0){ calMonth=12; calYear--; } loadCalendar(); });
  $("nextMonth").addEventListener("click",(e)=>{ e.preventDefault(); calMonth++; if(calMonth>=13){ calMonth=1; calYear++; } loadCalendar(); });
  $("calBus").addEventListener("change", ()=>loadCalendar());
  $("closeModal").addEventListener("click",(e)=>{ e.preventDefault(); closeModal(); });
  $("dayModal").addEventListener("click",(e)=>{ if(e.target && e.target.id==="dayModal") closeModal(); });

  // weather 手動変更 → 保存
  $("weather").addEventListener("change", ()=>{
    try{ localStorage.setItem(LS.weather, $("weather").value || ""); }catch{}
  });

  // ===== Init =====
  initCounts();
  buildMatrix();
  initMobileTabs();

  // date init
  $("date").value = new Date().toISOString().slice(0,10);

  // bus init
  let lastBus = "";
  try{ lastBus = localStorage.getItem(LS.lastBus) || ""; }catch{}
  $("bus").value = (lastBus==="A"||lastBus==="B") ? lastBus : "A";
  $("bus").dispatchEvent(new Event("change"));

  // 天気：前回値を一旦復元 → その後に大阪を自動取得で上書き
  try{
    const w = localStorage.getItem(LS.weather);
    if(w) $("weather").value = w;
  }catch{}
  autoWeatherOsaka();

  recompute();
  renderInvTable();

  // calendar init
  const now = new Date();
  calYear = now.getFullYear();
  calMonth = now.getMonth()+1;
  loadCalendar();
})();
</script>
</body>
</html>
