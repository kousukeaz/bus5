
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒã‚¹å ±å‘Šæ–‡ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆåœ¨åº«ãƒ»å£²ä¸Šãƒ»ç©è¾¼ï¼‰è¡¨å…¥åŠ›ç‰ˆ</title>
  <style>
    :root { --b:#ddd; --bg:#fff; --muted:#666; --ok:#0a7; --ng:#c22; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
      margin:14px; line-height:1.35; background:#fafafa; color:#111;
    }
    h1{font-size:18px;margin:0 0 10px;}
    h2{font-size:15px;margin:0 0 8px;}
    .card{background:var(--bg);border:1px solid var(--b);border-radius:12px;padding:12px;margin:12px 0;}
    label{display:block;font-size:12px;margin-top:10px;color:#222;}
    input,select,textarea,button{
      width:100%;font-size:16px;padding:10px;border-radius:10px;border:1px solid #ccc;box-sizing:border-box;background:#fff;
    }
    textarea{min-height:110px;}
    button{background:#0a7;color:#fff;border:none;cursor:pointer;}
    button.sub{background:#555;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    .btnrow2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .btnrow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;}
    .small{font-size:12px;color:var(--muted);}
    .status{font-size:12px;margin-top:8px;}
    .ok{color:var(--ok);}
    .ng{color:var(--ng);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Mono","Segoe UI Mono",monospace;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left;vertical-align:middle;}
    th{color:#333;font-weight:600;}
    .warn{color:var(--ng);font-size:12px;margin-top:6px;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:12px;color:#333;border:1px solid #e3e3e3;}
    .stickyWrap{overflow:auto;border:1px solid #eee;border-radius:12px;background:#fff;}
    .matrix{min-width: 920px;}
    .matrix th{position: sticky;top: 0;background: #fff;z-index: 1;}
    .matrix td:first-child, .matrix th:first-child{position: sticky;left: 0;background: #fff;z-index: 2;}
    .cellNum{width: 92px;padding: 6px;font-size: 14px;border-radius: 8px;}
    .rowTag{white-space:nowrap;}
    .divider{height:1px;background:#eee;margin:12px 0;}
  </style>
</head>
<body>
  <h1>ãƒã‚¹å ±å‘Šæ–‡ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆåœ¨åº«ãƒ»å£²ä¸Šãƒ»ç©è¾¼ï¼‰è¡¨å…¥åŠ›ç‰ˆ</h1>

  <div class="card">
    <h2>â‘  åŸºæœ¬æƒ…å ±</h2>
    <div class="grid3">
      <div>
        <label>æ—¥ä»˜ï¼ˆJSTå½“æ—¥ãŒåˆæœŸå€¤ï¼‰</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>ãƒã‚¹ï¼ˆA/Bï¼‰ <span class="pill">æ™‚åˆ»ã§åˆæœŸå€¤</span></label>
        <select id="bus">
          <option value="A">ãƒã‚¹A</option>
          <option value="B">ãƒã‚¹B</option>
        </select>
        <div class="small" id="busAutoHint"></div>
      </div>
      <div>
        <label>å¤©æ°—ï¼ˆé¸æŠï¼‰ <span class="pill">å¤©æ°—ã§åˆæœŸå€¤</span></label>
        <select id="weather">
          <option value="">ï¼ˆæœªå…¥åŠ›ï¼‰</option>
          <option value="æ™´ã‚Œ">æ™´ã‚Œ</option>
          <option value="ãã‚‚ã‚Š">ãã‚‚ã‚Š</option>
          <option value="é›¨">é›¨</option>
        </select>
        <div class="small" id="weatherHint"></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <label id="leader1Label">A1ï¼ˆå…¥åŠ›ï¼‰</label>
        <input id="leader1" type="text" placeholder="ä¾‹ï¼šã‚¸ãƒ§ãƒ¼ã‚¸" />
      </div>
      <div>
        <label id="leader2Label">A2ï¼ˆå…¥åŠ›ãƒ»ä¿å­˜ã•ã‚Œã‚‹ï¼‰</label>
        <input id="leader2" type="text" placeholder="ä¾‹ï¼šã‚¸ãƒ§ãƒ¼ã‚¸" />
        <div class="small">â€»A2 / B2 ã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>â‘¡ å‰æ—¥åœ¨åº«ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆLINEæ–‡ã‚’ãã®ã¾ã¾ï¼‰</h2>
    <label>è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹ï¼š12/25(æœ¨)ãƒã‚±ãƒƒãƒˆåœ¨åº«â€¦ï¼‰</label>
    <textarea id="prevPaste" class="mono" placeholder="ã“ã“ã«å‰æ—¥ã®åœ¨åº«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸¸ã”ã¨ãƒšãƒ¼ã‚¹ãƒˆ"></textarea>
    <div class="btnrow2">
      <button id="parseBtn">ãƒ‘ãƒ¼ã‚¹ï¼ˆèª­ã¿å–ã‚Šï¼‰</button>
      <button id="clearPrevBtn" class="sub">è²¼ã‚Šä»˜ã‘ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- â˜…è‡ªå‹•å–å¾—ã¯å‰Šé™¤ï¼ˆfetchPrevBtn / fetchStatus ã‚’å‰Šé™¤ï¼‰ -->

    <div id="parseStatus" class="status small"></div>

    <div style="margin-top:10px;">
      <table>
        <thead>
          <tr><th>åˆ¸ç¨®</th><th>å‰æ—¥åœ¨åº«</th><th>ä»Šæ—¥å£²ä¸Šï¼ˆè¡¨ã®åˆè¨ˆï¼‰</th><th>ä»Šæ—¥åœ¨åº«</th></tr>
        </thead>
        <tbody id="invTable"></tbody>
      </table>
      <div id="invWarn" class="warn"></div>
    </div>
  </div>

  <div class="card">
    <h2>â‘¢ å£²ä¸Šå…¥åŠ›ï¼ˆè¡¨ï¼‰</h2>
    <div class="small">
      åˆ—é †ï¼šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ / ç¾é‡‘ / Klook / ãƒŠãƒ„ãƒ¡ã‚° / é–¢è¥¿ãƒ‘ã‚¹ / äº¤é€šç³»ICã€€
      â€»æœªå…¥åŠ›ã¯0ã€€
      â€»é‡‘é¡è¨ˆç®—ï¼šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ»ç¾é‡‘ãƒ»é–¢è¥¿ãƒ‘ã‚¹ãƒ»äº¤é€šç³»ICï¼ˆKlook/ãƒŠãƒ„ãƒ¡ã‚°ã¯é‡‘éŠ­ãªã—ï¼‰
    </div>
    <div class="stickyWrap" style="margin-top:10px;">
      <table class="matrix" id="salesMatrix">
        <thead>
          <tr>
            <th>é …ç›®</th>
            <th>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</th>
            <th>ç¾é‡‘</th>
            <th>Klook</th>
            <th>ãƒŠãƒ„ãƒ¡ã‚°</th>
            <th>é–¢è¥¿ãƒ‘ã‚¹</th>
            <th>äº¤é€šç³»IC</th>
          </tr>
        </thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>

    <div class="divider"></div>

    <div class="grid3">
      <div>
        <label>ç¨ç‡ï¼ˆ%ï¼‰</label>
        <input id="taxRate" type="number" min="0" step="0.1" value="10" inputmode="decimal" />
      </div>
      <div>
        <label>å£²ä¸Šï¼ˆç¨è¾¼ï¼‰â€»è¡¨ã‹ã‚‰è‡ªå‹•è¨ˆç®—</label>
        <input id="salesIn" type="text" readonly />
      </div>
      <div>
        <label>å£²ä¸Šï¼ˆç¨åˆ¥ï¼‰â€»è‡ªå‹•</label>
        <input id="salesEx" type="text" readonly />
      </div>
    </div>

    <div class="grid3">
      <div><label>ã€ç¾é‡‘åˆè¨ˆã€‘</label><input id="cashSum" type="text" readonly /></div>
      <div><label>ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆè¨ˆã€‘</label><input id="creditSum" type="text" readonly /></div>
      <div><label>ã€äº¤é€šç³»åˆè¨ˆã€‘</label><input id="icSum" type="text" readonly /></div>
    </div>
    <div class="grid3">
      <div><label>ã€é–¢è¥¿ãƒ‘ã‚¹åˆè¨ˆã€‘</label><input id="kansaiSum" type="text" readonly /></div>
      <div><label>ï¼ˆå‚è€ƒï¼‰Klookæšæ•°åˆè¨ˆ</label><input id="klookCount" type="text" readonly /></div>
      <div><label>ï¼ˆå‚è€ƒï¼‰ãƒŠãƒ„ãƒ¡ã‚°æšæ•°åˆè¨ˆ</label><input id="nutsmegCount" type="text" readonly /></div>
    </div>

    <!-- â˜…è¿½åŠ ï¼šå£²ä¸Šã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ² -->
    <div class="btnrow2" style="margin-top:10px;">
      <button id="saveSalesBtn">å£²ä¸Šã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ï¼ˆé‡è¤‡ä¸å¯ï¼‰</button>
      <div id="saveStatus" class="status small"></div>
    </div>
  </div>

  <div class="card">
    <h2>â‘£ ç©è¾¼ä¾é ¼ï¼ˆå¿…è¦ãªå ´åˆã®ã¿å‡ºåŠ›ï¼‰</h2>
    <div class="grid2">
      <div>
        <label>@ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆåˆæœŸå€¤ã‚ã‚Šã€‚è¤‡æ•°OKï¼šæ”¹è¡Œ/ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label>
        <textarea id="mentions" class="mono">@Tominaga
@chawğŸ¦‹âŸ­âŸ¬â·ğŸ’œ</textarea>
      </div>
      <div>
        <label>è¿½åŠ ä¾é ¼ï¼ˆä»»æ„ï¼šçµæŸãƒãƒ³ãƒ‰ç­‰ã€‚è¡Œã”ã¨ï¼‰</label>
        <textarea id="extraLoad" class="mono" placeholder="çµæŸãƒãƒ³ãƒ‰(ã‚¯ãƒªã‚¹ãƒã‚¹ã®é£¾ä»˜ã‘ç”¨)"></textarea>
      </div>
    </div>
    <p class="small">â€»ä»Šæ—¥åœ¨åº«ãŒé–¾å€¤ä»¥ä¸‹ã«ãªã£ãŸåˆ¸ç¨®ã ã‘è‡ªå‹•ã§ç©è¾¼ä¾é ¼ã«å‡ºã—ã¾ã™ã€‚</p>
  </div>

  <div class="card">
    <h2>â‘¤ å‡ºåŠ›ï¼ˆLINEã«è²¼ã‚‹ï¼‰</h2>
    <div class="btnrow3">
      <button id="genInv">åœ¨åº«æ–‡ã‚’ç”Ÿæˆ</button>
      <button id="genSales">å£²ä¸Šæ–‡ã‚’ç”Ÿæˆ</button>
      <button id="genAll">å…¨éƒ¨ç”Ÿæˆï¼ˆåœ¨åº«ï¼‹å£²ä¸Šï¼‹å¿…è¦ãªã‚‰ç©è¾¼ï¼‰</button>
    </div>
    <div class="btnrow2">
      <button id="genLoad" class="sub">ç©è¾¼ä¾é ¼ã ã‘ç”Ÿæˆ</button>
      <button id="copy" class="sub">ã‚³ãƒ”ãƒ¼</button>
    </div>
    <div id="copyStatus" class="status ok" style="display:none;">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>
    <label>å‡ºåŠ›</label>
    <textarea id="out" class="mono" readonly></textarea>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // â˜…ã‚ãªãŸã®GASã® /exec URL ã«ç½®ãæ›ãˆã‚‹
  const GAS_URL = "https://script.google.com/macros/s/AKfycby0m1Xs3mewjjcQ1O8vAj3l9baMalwk0uZ64fhGvdcyOyCGXtC_43hUpIR7gMesq5UH/exec";

  const LS = {
    A2: "bus_report_A2",
    B2: "bus_report_B2",
    lastBus: "bus_report_lastBus",
    lastWeather: "bus_report_lastWeather"
  };

  // â‘ ã€œâ‘©ã®åˆ¸ç¨®ï¼ˆåœ¨åº«å¯¾è±¡ï¼‰
  const TICKETS = [
    { key:"t1",  no:"â‘ ", label:"OCPï¼‘DAY",                 out:"â‘ OCPï¼‘DAYâ†’",                channel:"OCP1dayï¼ˆå¤§äººï¼‰",      loadName:"OCP1dayï¼ˆå¤§äººï¼‰",      threshold:20, request:20 },
    { key:"t2",  no:"â‘¡", label:"OCPï¼’DAY",                 out:"â‘¡OCPï¼’DAYâ†’",                channel:"OCP2dayï¼ˆå¤§äººï¼‰",      loadName:"OCP2dayï¼ˆå¤§äººï¼‰",      threshold:20, request:10 },
    { key:"t3",  no:"â‘¢", label:"ãƒã‚¹ã®ã¿1DAY",             out:"â‘¢ãƒã‚¹ã®ã¿1DAYâ†’",            channel:"ãƒã‚¹ã®ã¿1DAYï¼ˆå¤§äººï¼‰", loadName:"ãƒã‚¹ã®ã¿1DAY(å¤§äºº)",   threshold:50, request:50 },
    { key:"t4",  no:"â‘£", label:"ãƒã‚¹ã®ã¿2DAY",             out:"â‘£ãƒã‚¹ã®ã¿2DAY â†’",           channel:"ãƒã‚¹ã®ã¿2DAYï¼ˆå¤§äººï¼‰", loadName:"ãƒã‚¹ã®ã¿2DAY(å¤§äºº)",   threshold:20, request:10 },
    { key:"t5",  no:"â‘¤", label:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿",             out:"â‘¤ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿â†’",            channel:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå¤§äººï¼‰", loadName:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿(å¤§äºº)",   threshold:10, request:10 },
    { key:"t6",  no:"â‘¥", label:"OCP1dayï¼ˆå­ä¾›ï¼‰",          out:"â‘¥OCP1dayï¼ˆå­ä¾›ï¼‰â†’",         channel:"OCP1dayï¼ˆå­ä¾›ï¼‰",      loadName:"OCP1dayï¼ˆå­ä¾›ï¼‰",      threshold:10, request:10 },
    { key:"t7",  no:"â‘¦", label:"OCP2dayï¼ˆå­ä¾›)",           out:"â‘¦OCP2dayï¼ˆå­ä¾›) â†’",         channel:"OCP2dayï¼ˆå­ä¾›ï¼‰",      loadName:"OCP2dayï¼ˆå­ä¾›ï¼‰",      threshold:10, request:10 },
    { key:"t8",  no:"â‘§", label:"ãƒã‚¹ã®ã¿ 1DAY ï¼ˆå­ä¾›)",    out:"â‘§ãƒã‚¹ã®ã¿ 1DAY ï¼ˆå­ä¾›)â†’",   channel:"ãƒã‚¹ã®ã¿1DAYï¼ˆå­ä¾›ï¼‰", loadName:"ãƒã‚¹ã®ã¿1DAYï¼ˆå­ä¾›ï¼‰", threshold:20, request:10 },
    { key:"t9",  no:"â‘¨", label:"ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰",     out:"â‘¨ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰â†’",    channel:"ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰", loadName:"ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰", threshold:10, request:10 },
    { key:"t10", no:"â‘©", label:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰",     out:"â‘©ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰â†’",    channel:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰", loadName:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰", threshold:10, request:10 },
  ];

  const GOODS = [
    { key:"g_water", label:"æ°´", unit:"æœ¬", price:200, outLine:(n)=>`æ°´x${n}æœ¬` },
    { key:"g_umb",   label:"å‚˜", unit:"æœ¬", price:500, outLine:(n)=>`å‚˜ Ã— ${n}æœ¬` },
    { key:"g_kairo", label:"ã‚«ã‚¤ãƒ­", unit:"æš", price:100, outLine:(n)=>`ã‚«ã‚¤ãƒ­x${n}æš` },
  ];

  const COLS = [
    { key:"credit", label:"ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ", money:true },
    { key:"cash",   label:"ç¾é‡‘",       money:true },
    { key:"klook",  label:"Klook",      money:false },
    { key:"nutsmeg",label:"ãƒŠãƒ„ãƒ¡ã‚°",   money:false },
    { key:"kansai", label:"é–¢è¥¿ãƒ‘ã‚¹",   money:true },
    { key:"ic",     label:"äº¤é€šç³»IC",   money:true },
  ];

  const PRICE = {
    t1: 6000,  t2: 8200,  t3: 4400,  t4: 6600,  t5: 2000,
    t6: 3300,  t7: 4400,  t8: 2200,  t9: 3300,  t10: 800,
    g_water: 200, g_umb: 500, g_kairo: 100
  };

  function unitPrice(rowKey, colKey){
    if(colKey === "kansai" && rowKey === "t3") return 2500;
    if(colKey === "kansai" && rowKey === "t8") return 1500;
    return PRICE[rowKey] ?? 0;
  }

  let prevInv = Object.fromEntries(TICKETS.map(t => [t.key, 0]));
  let detectedPrevStaff = "";
  let detectedPrevBus = "";

  const ALL_ROWS = [
    ...TICKETS.map(t=>({key:t.key, label:`${t.no}${t.label}`, kind:"ticket"})),
    ...GOODS.map(g=>({key:g.key, label:`${g.label}`, kind:"goods"})),
  ];

  let counts = {};
  function initCounts(){
    counts = {};
    for(const r of ALL_ROWS){
      counts[r.key] = {};
      for(const c of COLS) counts[r.key][c.key] = 0;
    }
  }

  function toInt(v){
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) && n > 0 ? Math.floor(n) : 0;
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function jpWeekday(d){ return ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()]; }

  function getJSTParts(){
    const dtf = new Intl.DateTimeFormat("ja-JP", { timeZone:"Asia/Tokyo", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", hour12:false });
    const parts = dtf.formatToParts(new Date());
    const get = (type) => parts.find(p=>p.type===type)?.value;
    return { y:+get("year"), m:+get("month"), d:+get("day"), hh:+get("hour"), mm:+get("minute") };
  }
  function initDateToJSTToday(){
    const {y,m,d} = getJSTParts();
    $("date").value = `${y}-${pad2(m)}-${pad2(d)}`;
  }
  function dateFromInput(){
    const s = $("date").value;
    if(!s){
      const {y,m,d} = getJSTParts();
      return new Date(`${y}-${pad2(m)}-${pad2(d)}T00:00:00`);
    }
    return new Date(s + "T00:00:00");
  }
  function fmtStock(d){ return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}(${jpWeekday(d)})`; }
  function fmtSales(d){ return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeekday(d)})`; }

  function autoDefaultBusByTime(){
    const {hh, mm} = getJSTParts();
    const isA = (hh < 17) || (hh === 17 && mm <= 30);
    return isA ? "A" : "B";
  }

  function mapWeatherCodeToJP(code){
    if(code === 0) return "æ™´ã‚Œ";
    if(code >= 1 && code <= 3) return "ãã‚‚ã‚Š";
    if(code === 45 || code === 48) return "ãã‚‚ã‚Š";
    if((code >= 51 && code <= 67) || (code >= 80 && code <= 82) || code >= 95) return "é›¨";
    if(code >= 71 && code <= 77) return "é›¨";
    return "ãã‚‚ã‚Š";
  }

  async function fetchWeatherDefault(){
    const hint = $("weatherHint");
    hint.textContent = "å¤©æ°—å–å¾—ä¸­â€¦";
    const fallback = { lat: 34.6937, lon: 135.5023, note: "ï¼ˆä½ç½®æƒ…å ±ãªã—ï¼šå¤§é˜ªå›ºå®šï¼‰" };

    const getPos = () => new Promise((resolve) => {
      if(!navigator.geolocation) return resolve(fallback);
      navigator.geolocation.getCurrentPosition(
        (pos)=>resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, note:"ï¼ˆç¾åœ¨åœ°ï¼‰" }),
        ()=>resolve(fallback),
        { enableHighAccuracy:false, timeout:3500, maximumAge: 60_000 }
      );
    });

    const {lat, lon, note} = await getPos();

    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&timezone=Asia%2FTokyo`;
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("fetch failed");
      const data = await res.json();
      const code = data?.current_weather?.weathercode;
      if(typeof code !== "number") throw new Error("no code");
      const jp = mapWeatherCodeToJP(code);

      if(!$("weather").dataset.touched){
        $("weather").value = jp;
        try{ localStorage.setItem(LS.lastWeather, jp); }catch{}
      }
      hint.textContent = `å¤©æ°—è‡ªå‹•è¨­å®šï¼š${jp} ${note}`;
    }catch{
      hint.textContent = `å¤©æ°—å–å¾—å¤±æ•—ï¼ˆæœªé¸æŠã®ã¾ã¾ï¼‰${note}`;
    }
  }

  function updateLeaderUI(){
    const bus = $("bus").value;
    if(bus === "A"){
      $("leader1Label").textContent = "A1ï¼ˆå…¥åŠ›ï¼‰";
      $("leader2Label").textContent = "A2ï¼ˆå…¥åŠ›ãƒ»ä¿å­˜ã•ã‚Œã‚‹ï¼‰";
      try{ $("leader2").value = localStorage.getItem(LS.A2) || $("leader2").value; }catch{}
    }else{
      $("leader1Label").textContent = "B1ï¼ˆå…¥åŠ›ï¼‰";
      $("leader2Label").textContent = "B2ï¼ˆå…¥åŠ›ãƒ»ä¿å­˜ã•ã‚Œã‚‹ï¼‰";
      try{ $("leader2").value = localStorage.getItem(LS.B2) || $("leader2").value; }catch{}
    }
  }
  function persistLeader2(){
    const bus = $("bus").value;
    const v = ($("leader2").value || "").trim();
    try{
      if(bus === "A") localStorage.setItem(LS.A2, v);
      else localStorage.setItem(LS.B2, v);
    }catch{}
  }
  function leaderLine(){
    const bus = $("bus").value;
    const l1 = ($("leader1").value || "").trim() || "ï¼ˆæœªå…¥åŠ›ï¼‰";
    const l2 = ($("leader2").value || "").trim() || "ï¼ˆæœªå…¥åŠ›ï¼‰";
    return bus === "A" ? `æ‹…å½“: A1${l1}ã€ A2${l2}` : `æ‹…å½“: B1${l1}ã€ B2${l2}`;
  }

  function parsePrevText(text){
    const res = { ok:true, missing:[], inv:{}, staff:"", bus:"" };

    const busM = text.match(/ãƒã‚¹\s*([AB])/i);
    res.bus = busM ? busM[1].toUpperCase() : "";

    const staffM = text.match(/æ‹…å½“\s*[:ï¼š]\s*([^\n\r]+)/);
    res.staff = staffM ? staffM[1].trim() : "";

    const arrow = "(?:â†’|â‡’|â”|->|ï¼)";
    for(const t of TICKETS){
      const sym = t.no.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const re = new RegExp(sym + "[^\\n\\r]*?" + arrow + "\\s*(\\d+)", "i");
      const m = text.match(re);
      if(!m){
        res.ok = false;
        res.missing.push(t.no);
        res.inv[t.key] = 0;
      }else{
        res.inv[t.key] = toInt(m[1]);
      }
    }
    return res;
  }
  function applyParsed(parsed){
    prevInv = Object.fromEntries(TICKETS.map(t => [t.key, parsed.inv[t.key] ?? 0]));
    detectedPrevStaff = parsed.staff || "";
    detectedPrevBus = parsed.bus || "";
  }
  function showParseStatus(parsed){
    const extra = [];
    if(detectedPrevBus) extra.push(`è²¼ä»˜ã‘æ¤œå‡ºãƒã‚¹: ${detectedPrevBus}`);
    if(detectedPrevStaff) extra.push(`è²¼ä»˜ã‘æ¤œå‡ºæ‹…å½“: ${detectedPrevStaff}`);
    const extraText = extra.length ? `ï¼ˆ${extra.join(" / ")}ï¼‰` : "";

    if(parsed.ok){
      $("parseStatus").innerHTML = `<span class="ok">ãƒ‘ãƒ¼ã‚¹æˆåŠŸ</span>${extraText}`;
    }else{
      $("parseStatus").innerHTML = `<span class="ng">ãƒ‘ãƒ¼ã‚¹ä¸€éƒ¨å¤±æ•—</span>ï¼šå–å¾—ã§ããªã„è¡Œ ${parsed.missing.join(" ")}ï¼ˆè©²å½“ã¯0æ‰±ã„ï¼‰${extraText}`;
    }
  }

  function buildMatrix(){
    const tb = $("matrixBody");
    tb.innerHTML = "";
    for(const r of ALL_ROWS){
      const tr = document.createElement("tr");
      const first = document.createElement("td");
      first.className = "rowTag";
      first.textContent = r.label;
      tr.appendChild(first);

      for(const c of COLS){
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.className = "cellNum";
        inp.type = "number";
        inp.min = "0";
        inp.inputMode = "numeric";
        inp.value = "0";
        inp.id = `cell_${r.key}_${c.key}`;
        inp.addEventListener("input", () => {
          counts[r.key][c.key] = toInt(inp.value);
          recomputeFromMatrix();
          renderInvTable();
        });
        td.appendChild(inp);
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
  }

  function soldCountForTicket(ticketKey){
    let s = 0;
    for(const c of COLS) s += (counts[ticketKey]?.[c.key] ?? 0);
    return s;
  }

  function moneyTotals(){
    let credit=0, cash=0, kansai=0, ic=0, gross=0;
    let klookCount=0, nutsmegCount=0;

    for(const r of ALL_ROWS){
      klookCount += (counts[r.key]?.klook ?? 0);
      nutsmegCount += (counts[r.key]?.nutsmeg ?? 0);

      for(const colKey of ["credit","cash","kansai","ic"]){
        const n = counts[r.key]?.[colKey] ?? 0;
        if(n <= 0) continue;
        const unit = unitPrice(r.key, colKey);
        const amt = n * unit;
        gross += amt;
        if(colKey==="credit") credit += amt;
        if(colKey==="cash") cash += amt;
        if(colKey==="kansai") kansai += amt;
        if(colKey==="ic") ic += amt;
      }
    }
    return { credit, cash, kansai, ic, gross, klookCount, nutsmegCount };
  }

  function recomputeFromMatrix(){
    const { credit, cash, kansai, ic, gross, klookCount, nutsmegCount } = moneyTotals();
    const rate = Number($("taxRate").value || 10) / 100;
    const ex = Math.round(gross / (1 + rate));

    $("salesIn").value = `${gross.toLocaleString()}å††`;
    $("salesEx").value = `${ex.toLocaleString()}å††`;
    $("cashSum").value = `${cash.toLocaleString()}å††`;
    $("creditSum").value = `${credit.toLocaleString()}å††`;
    $("icSum").value = `${ic.toLocaleString()}å††`;
    $("kansaiSum").value = `${kansai.toLocaleString()}å††`;
    $("klookCount").value = `${klookCount}æš`;
    $("nutsmegCount").value = `${nutsmegCount}æš`;
  }

  function todayInvFor(ticket){
    const p = prevInv[ticket.key] ?? 0;
    const s = soldCountForTicket(ticket.key);
    const raw = p - s;
    return raw >= 0 ? raw : 0;
  }

  function renderInvTable(){
    const tbody = $("invTable");
    tbody.innerHTML = "";
    const warn = [];

    for(const t of TICKETS){
      const p = prevInv[t.key] ?? 0;
      const s = soldCountForTicket(t.key);
      const ti = todayInvFor(t);

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.no} ${t.label}</td><td>${p}</td><td>${s}</td><td>${ti}</td>`;
      tbody.appendChild(tr);

      if(s > p) warn.push(`${t.no}ï¼ˆå£²ä¸Š ${s} ãŒå‰æ—¥åœ¨åº« ${p} ã‚’è¶…éï¼‰`);
    }
    $("invWarn").textContent = warn.length ? ("è­¦å‘Š: " + warn.join(" / ") + "ï¼ˆä»Šæ—¥åœ¨åº«ã¯0ã«ä¸¸ã‚ã¾ã—ãŸï¼‰") : "";
  }

  function buildStockMessage(d){
    const bus = $("bus").value;
    const lines = [];
    lines.push(`${fmtStock(d)}ãƒã‚±ãƒƒãƒˆåœ¨åº«`);
    lines.push(`ãƒã‚¹${bus}`);
    lines.push("");
    for(const t of TICKETS){
      lines.push(`${t.out}${todayInvFor(t)}`);
    }
    lines.push("");
    lines.push(leaderLine());
    return lines.join("\n");
  }

  function buildChannelLinesFor(key){
    const lines = [];
    for(const t of TICKETS){
      const v = counts[t.key]?.[key] ?? 0;
      if(v > 0) lines.push(`${t.channel}${v}å`);
    }
    return lines;
  }

  function goodsLinesFromMatrix(){
    const out = [];
    for(const g of GOODS){
      const total = COLS.reduce((a,c)=>a + (counts[g.key]?.[c.key] ?? 0), 0);
      if(total > 0) out.push(g.outLine(total));
    }
    return out;
  }

  function buildSalesMessage(d){
    const bus = $("bus").value;
    const weather = $("weather").value || "ï¼ˆæœªå…¥åŠ›ï¼‰";
    const { credit, cash, ic, gross } = moneyTotals();
    const rate = Number($("taxRate").value || 10) / 100;
    const ex = Math.round(gross / (1 + rate));

    const klookLines = buildChannelLinesFor("klook");
    const nutsmegLines = buildChannelLinesFor("nutsmeg");
    const kansaiLines = buildChannelLinesFor("kansai");
    const goodsLines = goodsLinesFromMatrix();

    const lines = [];
    lines.push(`${fmtSales(d)}`);
    lines.push(`ãƒã‚¹${bus}`);
    lines.push(leaderLine());
    lines.push(`å¤©æ°—:  ${weather}`);
    lines.push("");
    lines.push(`å£²ä¸Š ${ex.toLocaleString()}å††ï¼ˆç¨åˆ¥ï¼‰`);
    lines.push(`   ${gross.toLocaleString()}å††ï¼ˆç¨è¾¼ï¼‰`);
    lines.push("");
    lines.push(`ã€ç¾é‡‘åˆè¨ˆã€‘${cash.toLocaleString()}å††`);
    lines.push(`ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆè¨ˆã€‘${credit.toLocaleString()}å††`);
    lines.push(`ã€äº¤é€šç³»åˆè¨ˆã€‘${ic.toLocaleString()}å††`);

    lines.push(`ã€klookã€‘`);
    if(klookLines.length) lines.push(...klookLines);
    lines.push(`ã€ãƒŠãƒ„ãƒ¡ã‚°ã€‘`);
    if(nutsmegLines.length) lines.push(...nutsmegLines);
    lines.push(`ã€é–¢è¥¿ãƒ‘ã‚¹ã€‘`);
    if(kansaiLines.length) lines.push(...kansaiLines);

    if(goodsLines.length){
      lines.push("");
      lines.push(...goodsLines);
    }
    return lines.join("\n");
  }

  function parseMentions(text){
    const raw = (text || "").trim();
    if(!raw) return [];
    return raw.split(/[\n\r\s]+/).map(s=>s.trim()).filter(Boolean);
  }

  function buildLoadRequestMessage(){
    const bus = $("bus").value;

    const needed = [];
    for(const t of TICKETS){
      const inv = todayInvFor(t);
      if(inv <= t.threshold) needed.push(`${t.loadName}x${t.request}`);
    }

    const extras = ($("extraLoad").value || "").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!needed.length && !extras.length) return "";

    const mentions = parseMentions($("mentions").value);
    const lines = [];
    if(mentions.length) lines.push(...mentions);
    lines.push("");
    lines.push("ãŠç–²ã‚Œæ§˜ã§ã™ï¼");
    lines.push("ä¸‹è¨˜ç©è¾¼ã¿ãŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼");
    lines.push("");
    lines.push("ã€ç©è¾¼ä¾é ¼ã€‘");
    lines.push(`ãƒã‚¹${bus}`);
    if(needed.length) lines.push(...needed);
    if(extras.length) lines.push(...extras);
    return lines.join("\n");
  }

  function setOutput(text){ $("out").value = text; }

  async function copyOutput(){
    const text = $("out").value || "";
    if(!text.trim()) return;
    try{
      await navigator.clipboard.writeText(text);
      $("copyStatus").style.display = "block";
      setTimeout(()=> $("copyStatus").style.display="none", 1200);
    }catch{
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
    }
  }

  // â˜…è¿½åŠ ï¼šå£²ä¸Šã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ï¼ˆé‡è¤‡ä¸å¯ï¼‰
  async function saveSalesToSheet(){
    const st = $("saveStatus");
    st.textContent = "ä¿å­˜ä¸­â€¦";
    st.className = "status small";

    if(!GAS_URL || !GAS_URL.startsWith("https://script.google.com/")){
      st.textContent = "GAS_URLãŒæœªè¨­å®šã§ã™ï¼ˆ/exec URLã‚’è²¼ã£ã¦ãã ã•ã„ï¼‰";
      st.className = "status small ng";
      return;
    }

    const date = $("date").value; // YYYY-MM-DD
    const bus  = $("bus").value;  // A/B
    if(!date){
      st.textContent = "æ—¥ä»˜ãŒæœªå…¥åŠ›ã§ã™";
      st.className = "status small ng";
      return;
    }

    const d = dateFromInput();
    const salesText = buildSalesMessage(d);

    const { credit, cash, kansai, ic, gross, klookCount, nutsmegCount } = moneyTotals();
    const rate = Number($("taxRate").value || 10) / 100;
    const ex = Math.round(gross / (1 + rate));

    const payload = {
      date, bus,
      weather: $("weather").value || "",
      leader1: ($("leader1").value || "").trim(),
      leader2: ($("leader2").value || "").trim(),
      taxRate: Number($("taxRate").value || 10),
      gross, ex, cash, credit, ic, kansai, klookCount, nutsmegCount,
      salesText,
      matrix: counts
    };

    try{
      const res = await fetch(`${GAS_URL}?action=saveSales`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "unknown");

      st.textContent = `ä¿å­˜æˆåŠŸï¼š${data.key}`;
      st.className = "status small ok";
    }catch(e){
      st.textContent = `ä¿å­˜å¤±æ•—ï¼š${e.message || e}`;
      st.className = "status small ng";
    }
  }

  // --- events ---
  $("taxRate").addEventListener("input", () => recomputeFromMatrix());

  $("parseBtn").addEventListener("click", (e) => {
    e.preventDefault();
    const text = $("prevPaste").value || "";
    const parsed = parsePrevText(text);
    applyParsed(parsed);
    showParseStatus(parsed);
    renderInvTable();
  });

  $("clearPrevBtn").addEventListener("click", (e) => {
    e.preventDefault();
    $("prevPaste").value = "";
    $("parseStatus").textContent = "";
    detectedPrevStaff = "";
    detectedPrevBus = "";
    prevInv = Object.fromEntries(TICKETS.map(t => [t.key, 0]));
    renderInvTable();
  });

  $("prevPaste").addEventListener("input", () => {
    const text = $("prevPaste").value || "";
    if(text.trim().length < 10) return;
    const parsed = parsePrevText(text);
    applyParsed(parsed);
    showParseStatus(parsed);
    renderInvTable();
  });

  $("genInv").addEventListener("click", (e) => {
    e.preventDefault();
    const d = dateFromInput();
    setOutput(buildStockMessage(d));
  });

  $("genSales").addEventListener("click", (e) => {
    e.preventDefault();
    const d = dateFromInput();
    setOutput(buildSalesMessage(d));
  });

  $("genLoad").addEventListener("click", (e) => {
    e.preventDefault();
    const msg = buildLoadRequestMessage();
    setOutput(msg || "ï¼ˆç©è¾¼ä¾é ¼ï¼šè©²å½“ãªã—ï¼‰");
  });

  $("genAll").addEventListener("click", (e) => {
    e.preventDefault();
    const d = dateFromInput();
    const stock = buildStockMessage(d);
    const sales = buildSalesMessage(d);
    const load = buildLoadRequestMessage();
    const all = load ? (stock + "\n\n" + sales + "\n\n" + load) : (stock + "\n\n" + sales);
    setOutput(all);
  });

  $("copy").addEventListener("click", async (e) => {
    e.preventDefault();
    if(!($("out").value || "").trim()) $("genAll").click();
    await copyOutput();
  });

  $("bus").addEventListener("change", () => {
    updateLeaderUI();
    try{ localStorage.setItem(LS.lastBus, $("bus").value); }catch{}
  });

  $("leader2").addEventListener("input", () => persistLeader2());
  $("weather").addEventListener("change", () => { $("weather").dataset.touched = "1"; try{ localStorage.setItem(LS.lastWeather, $("weather").value);}catch{} });

  $("saveSalesBtn").addEventListener("click", (e) => {
    e.preventDefault();
    saveSalesToSheet();
  });

  // --- init ---
  function initBusDefault(){
    let chosen = "";
    try{ chosen = localStorage.getItem(LS.lastBus) || ""; }catch{}
    if(chosen !== "A" && chosen !== "B"){
      chosen = autoDefaultBusByTime();
      $("busAutoHint").textContent = `æ™‚åˆ»(JST)ã«ã‚ˆã‚ŠåˆæœŸå€¤ï¼šãƒã‚¹${chosen}`;
    }else{
      $("busAutoHint").textContent = `å‰å›é¸æŠã‚’å¾©å…ƒï¼šãƒã‚¹${chosen}`;
    }
    $("bus").value = chosen;
  }

  function initWeatherDefault(){
    let chosen = "";
    try{ chosen = localStorage.getItem(LS.lastWeather) || ""; }catch{}
    if(chosen && !$("weather").dataset.touched){
      $("weather").value = chosen;
      $("weatherHint").textContent = `å‰å›é¸æŠã‚’å¾©å…ƒï¼š${chosen}`;
    }
    fetchWeatherDefault();
  }

  initCounts();
  buildMatrix();
  initDateToJSTToday();
  initBusDefault();
  updateLeaderUI();
  initWeatherDefault();
  recomputeFromMatrix();
  renderInvTable();
})();
</script>
</body>
</html>
