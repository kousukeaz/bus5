


<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒã‚¹å ±å‘Šæ–‡ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆåœ¨åº«ãƒ»å£²ä¸Šãƒ»ç©è¾¼ï¼‰è¡¨å…¥åŠ›ç‰ˆ</title>
  <style>
    :root { --b:#ddd; --bg:#fff; --muted:#666; --ok:#0a7; --ng:#c22; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
      margin:14px; line-height:1.35; background:#fafafa; color:#111;
    }
    h1{font-size:18px;margin:0 0 10px;}
    h2{font-size:15px;margin:0 0 8px;}
    .card{background:var(--bg);border:1px solid var(--b);border-radius:12px;padding:12px;margin:12px 0;}
    label{display:block;font-size:12px;margin-top:10px;color:#222;}
    input,select,textarea,button{
      width:100%;font-size:16px;padding:10px;border-radius:10px;border:1px solid #ccc;box-sizing:border-box;background:#fff;
    }
    textarea{min-height:110px;}
    button{background:#0a7;color:#fff;border:none;cursor:pointer;}
    button.sub{background:#555;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    .btnrow2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .btnrow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;}
    .small{font-size:12px;color:var(--muted);}
    .status{font-size:12px;margin-top:8px;}
    .ok{color:var(--ok);}
    .ng{color:var(--ng);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Mono","Segoe UI Mono",monospace;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{border-bottom:1px solid #eee;padding:6px 4px;text-align:left;vertical-align:middle;}
    th{color:#333;font-weight:600;}
    .warn{color:var(--ng);font-size:12px;margin-top:6px;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:12px;color:#333;border:1px solid #e3e3e3;}
    .stickyWrap{overflow:auto;border:1px solid #eee;border-radius:12px;background:#fff;}
    .matrix{min-width: 920px;}
    .matrix th{position: sticky;top: 0;background: #fff;z-index: 1;}
    .matrix td:first-child, .matrix th:first-child{position: sticky;left: 0;background: #fff;z-index: 2;}
    .cellNum{width: 92px;padding: 6px;font-size: 14px;border-radius: 8px;}
    .rowTag{white-space:nowrap;}
    .divider{height:1px;background:#eee;margin:12px 0;}

    /* ===== Calendar styles ===== */
    .calGrid{ display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; }
    .calDow{ font-size:12px;color:var(--muted); text-align:center; }
    .calCell{ background:#fff;border:1px solid #eee;border-radius:12px; padding:10px; min-height:72px; }
    .calCell button{
      width:100%; background:transparent; color:#111; border:none; padding:0; cursor:pointer; text-align:left;
    }
    .calDate{ font-weight:700;font-size:14px; }
    .calMoney{ margin-top:6px; font-size:12px; color:#0a7; }
    .calEmpty{ background:transparent;border:none; }
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; padding:16px;
    }
    .modal[aria-hidden="false"]{ display:flex; }
    .modalInner{
      width:min(520px, 100%);
      background:#fff; border-radius:14px; padding:12px; border:1px solid #ddd;
    }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; gap:12px; }

/* ===== Mobile Fix (iPhone/Safari) ===== */
@media (max-width: 520px){
  body{ margin:10px; }

  /* 3åˆ—/2åˆ—ã‚’1åˆ—ã« */
  .grid3{ grid-template-columns: 1fr !important; }
  .grid2{ grid-template-columns: 1fr !important; }
  .btnrow3{ grid-template-columns: 1fr !important; }
  .btnrow2{ grid-template-columns: 1fr !important; }

  /* å…¥åŠ›ã§å‹æ‰‹ã«æ‹¡å¤§ã•ã‚Œãªã„ã‚ˆã†ã«ï¼ˆiOSã¯16pxæœªæº€ã§ã‚ºãƒ¼ãƒ ã—ãŒã¡ï¼‰ */
  input, select, textarea{ font-size:16px !important; }

  /* è¡¨ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ã‚’ç¢ºå®Ÿã«åŠ¹ã‹ã›ã‚‹ */
  .stickyWrap{
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
    border-radius: 12px;
  }

  /* iPhoneã§ sticky ãŒãƒã‚°ã‚Šã‚„ã™ã„ã®ã§ç„¡åŠ¹åŒ–ï¼ˆã“ã“ãŒä¸€ç•ªåŠ¹ãï¼‰ */
  .matrix th{ position: static !important; }
  .matrix td:first-child, .matrix th:first-child{ position: static !important; }

  /* æ¨ªå¹…ã‚’è©°ã‚ã‚‹ */
  .matrix{ min-width: 720px !important; }   /* 920 â†’ 720 ã«ç¸®ã‚ã‚‹ */
  .cellNum{
    width: 84px !important;
    font-size: 16px !important;
    padding: 8px !important;
  }

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼šã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
  .calCell{ min-height: 88px; }
  .calCell button{ padding: 4px 0; }
}

/* iOSã§100vhãŒã‚ºãƒ¬ã‚‹å•é¡Œã®è»½æ¸›ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç­‰ï¼‰ */
@supports (-webkit-touch-callout: none){
  .modalInner{ max-height: 80vh; overflow:auto; -webkit-overflow-scrolling: touch; }
}


  </style>
</head>

<body>
  <h1>ãƒã‚¹å ±å‘Šæ–‡ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆåœ¨åº«ãƒ»å£²ä¸Šãƒ»ç©è¾¼ï¼‰è¡¨å…¥åŠ›ç‰ˆ</h1>

  <div class="card">
    <h2>â‘  åŸºæœ¬æƒ…å ±</h2>
    <div class="grid3">
      <div>
        <label>æ—¥ä»˜ï¼ˆJSTå½“æ—¥ãŒåˆæœŸå€¤ï¼‰</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>ãƒã‚¹ï¼ˆA/Bï¼‰ <span class="pill">æ™‚åˆ»ã§åˆæœŸå€¤</span></label>
        <select id="bus">
          <option value="A">ãƒã‚¹A</option>
          <option value="B">ãƒã‚¹B</option>
        </select>
        <div class="small" id="busAutoHint"></div>
      </div>
      <div>
        <label>å¤©æ°—ï¼ˆé¸æŠï¼‰ <span class="pill">å¤©æ°—ã§åˆæœŸå€¤</span></label>
        <select id="weather">
          <option value="">ï¼ˆæœªå…¥åŠ›ï¼‰</option>
          <option value="æ™´ã‚Œ">æ™´ã‚Œ</option>
          <option value="ãã‚‚ã‚Š">ãã‚‚ã‚Š</option>
          <option value="é›¨">é›¨</option>
        </select>
        <div class="small" id="weatherHint"></div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <label id="leader1Label">A1ï¼ˆå…¥åŠ›ï¼‰</label>
        <input id="leader1" type="text" placeholder="ä¾‹ï¼šã‚¸ãƒ§ãƒ¼ã‚¸" />
      </div>
      <div>
        <label id="leader2Label">A2ï¼ˆå…¥åŠ›ãƒ»ä¿å­˜ã•ã‚Œã‚‹ï¼‰</label>
        <input id="leader2" type="text" placeholder="ä¾‹ï¼šã‚¸ãƒ§ãƒ¼ã‚¸" />
        <div class="small">â€»A2 / B2 ã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>â‘¡ å‰æ—¥åœ¨åº«ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆLINEæ–‡ã‚’ãã®ã¾ã¾ï¼‰</h2>
    <label>è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹ï¼š12/25(æœ¨)ãƒã‚±ãƒƒãƒˆåœ¨åº«â€¦ï¼‰</label>
    <textarea id="prevPaste" class="mono" placeholder="ã“ã“ã«å‰æ—¥ã®åœ¨åº«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸¸ã”ã¨ãƒšãƒ¼ã‚¹ãƒˆ"></textarea>
    <div class="btnrow2">
      <button id="parseBtn">ãƒ‘ãƒ¼ã‚¹ï¼ˆèª­ã¿å–ã‚Šï¼‰</button>
      <button id="clearPrevBtn" class="sub">è²¼ã‚Šä»˜ã‘ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="btnrow2" style="margin-top:10px;">
      <button id="fetchPrevBtn">å‰å›åœ¨åº«ã‚’è‡ªå‹•å–å¾—</button>
      <div id="fetchStatus" class="status small"></div>
    </div>

    <div id="parseStatus" class="status small"></div>

    <div style="margin-top:10px;">
      <table>
        <thead>
          <tr><th>åˆ¸ç¨®</th><th>å‰æ—¥åœ¨åº«</th><th>ä»Šæ—¥å£²ä¸Šï¼ˆè¡¨ã®åˆè¨ˆï¼‰</th><th>ä»Šæ—¥åœ¨åº«</th></tr>
        </thead>
        <tbody id="invTable"></tbody>
      </table>
      <div id="invWarn" class="warn"></div>
    </div>
  </div>

  <div class="card">
    <h2>â‘¢ å£²ä¸Šå…¥åŠ›ï¼ˆè¡¨ï¼‰</h2>
    <div class="small">
      åˆ—é †ï¼šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ / ç¾é‡‘ / Klook / ãƒŠãƒ„ãƒ¡ã‚° / é–¢è¥¿ãƒ‘ã‚¹ / äº¤é€šç³»ICã€€
      â€»æœªå…¥åŠ›ã¯0ã€€
      â€»é‡‘é¡è¨ˆç®—ï¼šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ»ç¾é‡‘ãƒ»é–¢è¥¿ãƒ‘ã‚¹ãƒ»äº¤é€šç³»ICï¼ˆKlook/ãƒŠãƒ„ãƒ¡ã‚°ã¯é‡‘éŠ­ãªã—ï¼‰
    </div>

    <div class="stickyWrap" style="margin-top:10px;">
      <table class="matrix" id="salesMatrix">
        <thead>
          <tr>
            <th>é …ç›®</th>
            <th>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</th>
            <th>ç¾é‡‘</th>
            <th>Klook</th>
            <th>ãƒŠãƒ„ãƒ¡ã‚°</th>
            <th>é–¢è¥¿ãƒ‘ã‚¹</th>
            <th>äº¤é€šç³»IC</th>
          </tr>
        </thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>

    <div class="divider"></div>

    <div class="grid3">
      <div>
        <label>ç¨ç‡ï¼ˆ%ï¼‰</label>
        <input id="taxRate" type="number" min="0" step="0.1" value="10" inputmode="decimal" />
      </div>
      <div>
        <label>å£²ä¸Šï¼ˆç¨è¾¼ï¼‰â€»è¡¨ã‹ã‚‰è‡ªå‹•è¨ˆç®—</label>
        <input id="salesIn" type="text" readonly />
      </div>
      <div>
        <label>å£²ä¸Šï¼ˆç¨åˆ¥ï¼‰â€»è‡ªå‹•</label>
        <input id="salesEx" type="text" readonly />
      </div>
    </div>

    <div class="grid3">
      <div><label>ã€ç¾é‡‘åˆè¨ˆã€‘</label><input id="cashSum" type="text" readonly /></div>
      <div><label>ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆè¨ˆã€‘</label><input id="creditSum" type="text" readonly /></div>
      <div><label>ã€äº¤é€šç³»åˆè¨ˆã€‘</label><input id="icSum" type="text" readonly /></div>
    </div>
    <div class="grid3">
      <div><label>ã€é–¢è¥¿ãƒ‘ã‚¹åˆè¨ˆã€‘</label><input id="kansaiSum" type="text" readonly /></div>
      <div><label>ï¼ˆå‚è€ƒï¼‰Klookæšæ•°åˆè¨ˆ</label><input id="klookCount" type="text" readonly /></div>
      <div><label>ï¼ˆå‚è€ƒï¼‰ãƒŠãƒ„ãƒ¡ã‚°æšæ•°åˆè¨ˆ</label><input id="nutsmegCount" type="text" readonly /></div>
    </div>
  </div>

  <div class="card">
    <h2>â‘£ ç©è¾¼ä¾é ¼ï¼ˆå¿…è¦ãªå ´åˆã®ã¿å‡ºåŠ›ï¼‰</h2>
    <div class="grid2">
      <div>
        <label>@ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ï¼ˆåˆæœŸå€¤ã‚ã‚Šã€‚è¤‡æ•°OKï¼šæ”¹è¡Œ/ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label>
        <textarea id="mentions" class="mono">@Tominaga
@chawğŸ¦‹âŸ­âŸ¬â·ğŸ’œ</textarea>
      </div>
      <div>
        <label>è¿½åŠ ä¾é ¼ï¼ˆä»»æ„ï¼šçµæŸãƒãƒ³ãƒ‰ç­‰ã€‚è¡Œã”ã¨ï¼‰</label>
        <textarea id="extraLoad" class="mono" placeholder="çµæŸãƒãƒ³ãƒ‰(ã‚¯ãƒªã‚¹ãƒã‚¹ã®é£¾ä»˜ã‘ç”¨)"></textarea>
      </div>
    </div>
    <p class="small">â€»ä»Šæ—¥åœ¨åº«ãŒé–¾å€¤ä»¥ä¸‹ã«ãªã£ãŸåˆ¸ç¨®ã ã‘è‡ªå‹•ã§ç©è¾¼ä¾é ¼ã«å‡ºã—ã¾ã™ã€‚</p>
  </div>

  <div class="card">
    <h2>â‘¤ å‡ºåŠ›ï¼ˆLINEã«è²¼ã‚‹ï¼‰</h2>
    <div class="btnrow3">
      <button id="genInv">åœ¨åº«æ–‡ã‚’ç”Ÿæˆ</button>
      <button id="genSales">å£²ä¸Šæ–‡ã‚’ç”Ÿæˆ</button>
      <button id="genAll">å…¨éƒ¨ç”Ÿæˆï¼ˆåœ¨åº«ï¼‹å£²ä¸Šï¼‹å¿…è¦ãªã‚‰ç©è¾¼ï¼‰</button>
    </div>

    <div class="btnrow3">
      <button id="saveToSheet" class="sub">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜</button>
      <button id="copy" class="sub">ã‚³ãƒ”ãƒ¼</button>
      <button id="refreshCalAfterSave" class="sub">ä¿å­˜å¾Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°</button>
    </div>

    <div id="saveStatus" class="status small"></div>
    <div id="copyStatus" class="status ok" style="display:none;">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

    <label>å‡ºåŠ›</label>
    <textarea id="out" class="mono" readonly></textarea>
  </div>

  <div class="card" id="historyCard">
    <h2>â‘¥ å±¥æ­´ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå£²ä¸Šãƒ»åœ¨åº«ï¼‰</h2>

    <div class="grid3">
      <div>
        <label>è¡¨ç¤ºãƒã‚¹</label>
        <select id="calBus">
          <option value="A">A</option>
          <option value="B">B</option>
        </select>
        <div class="small">â€»å…¥åŠ›ç”»é¢ã®ãƒã‚¹ã¨ã¯ç‹¬ç«‹</div>
      </div>

      <div>
        <label>è¡¨ç¤ºæœˆ</label>
        <div class="grid2">
          <button id="prevMonth" class="sub">â—€ å‰æœˆ</button>
          <button id="nextMonth" class="sub">æ¬¡æœˆ â–¶</button>
        </div>
        <div id="monthTitle" class="small" style="margin-top:6px;"></div>
      </div>

      <div>
        <label>æ“ä½œ</label>
        <button id="reloadCal" class="sub">ã“ã®æœˆã‚’å†èª­ã¿è¾¼ã¿</button>
        <div id="calStatus" class="status small"></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="calGrid" id="calGrid"></div>

    <div class="modal" id="dayModal" aria-hidden="true">
      <div class="modalInner">
        <div class="modalHead">
          <div id="dayModalTitle" style="font-weight:700;"></div>
          <button id="closeModal" class="sub" style="width:auto;padding:8px 10px;">é–‰ã˜ã‚‹</button>
        </div>
        <div id="dayModalBody" class="small"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // â˜…ã‚ãªãŸã®GASã® /exec URL ã«ç½®ãæ›ãˆã‚‹
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwbWy_qqSS8MDIejie8pza4BD4_WMIaDdNZ2ChUm_WJsDcfku0zb_rjA-d2HnRpQyRQ/exec";

  const LS = {
    A2: "bus_report_A2",
    B2: "bus_report_B2",
    lastBus: "bus_report_lastBus",
    lastWeather: "bus_report_lastWeather",
    clientId: "bus_report_client_id"
  };

  // â‘ ã€œâ‘©ã®åˆ¸ç¨®ï¼ˆåœ¨åº«å¯¾è±¡ï¼‰
  const TICKETS = [
    { key:"t1",  no:"â‘ ", label:"OCPï¼‘DAY",                 out:"â‘ OCPï¼‘DAYâ†’",                channel:"OCP1dayï¼ˆå¤§äººï¼‰",      loadName:"OCP1dayï¼ˆå¤§äººï¼‰",      threshold:20, request:20 },
    { key:"t2",  no:"â‘¡", label:"OCPï¼’DAY",                 out:"â‘¡OCPï¼’DAYâ†’",                channel:"OCP2dayï¼ˆå¤§äººï¼‰",      loadName:"OCP2dayï¼ˆå¤§äººï¼‰",      threshold:20, request:10 },
    { key:"t3",  no:"â‘¢", label:"ãƒã‚¹ã®ã¿1DAY",             out:"â‘¢ãƒã‚¹ã®ã¿1DAYâ†’",            channel:"ãƒã‚¹ã®ã¿1DAYï¼ˆå¤§äººï¼‰", loadName:"ãƒã‚¹ã®ã¿1DAY(å¤§äºº)",   threshold:50, request:50 },
    { key:"t4",  no:"â‘£", label:"ãƒã‚¹ã®ã¿2DAY",             out:"â‘£ãƒã‚¹ã®ã¿2DAY â†’",           channel:"ãƒã‚¹ã®ã¿2DAYï¼ˆå¤§äººï¼‰", loadName:"ãƒã‚¹ã®ã¿2DAY(å¤§äºº)",   threshold:20, request:10 },
    { key:"t5",  no:"â‘¤", label:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿",             out:"â‘¤ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿â†’",            channel:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå¤§äººï¼‰", loadName:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿(å¤§äºº)",   threshold:10, request:10 },
    { key:"t6",  no:"â‘¥", label:"OCP1dayï¼ˆå­ä¾›ï¼‰",          out:"â‘¥OCP1dayï¼ˆå­ä¾›ï¼‰â†’",         channel:"OCP1dayï¼ˆå­ä¾›ï¼‰",      loadName:"OCP1dayï¼ˆå­ä¾›ï¼‰",      threshold:10, request:10 },
    { key:"t7",  no:"â‘¦", label:"OCP2dayï¼ˆå­ä¾›)",           out:"â‘¦OCP2dayï¼ˆå­ä¾›) â†’",         channel:"OCP2dayï¼ˆå­ä¾›ï¼‰",      loadName:"OCP2dayï¼ˆå­ä¾›ï¼‰",      threshold:10, request:10 },
    { key:"t8",  no:"â‘§", label:"ãƒã‚¹ã®ã¿ 1DAY ï¼ˆå­ä¾›)",    out:"â‘§ãƒã‚¹ã®ã¿ 1DAY ï¼ˆå­ä¾›)â†’",   channel:"ãƒã‚¹ã®ã¿1DAYï¼ˆå­ä¾›ï¼‰", loadName:"ãƒã‚¹ã®ã¿1DAYï¼ˆå­ä¾›ï¼‰", threshold:20, request:10 },
    { key:"t9",  no:"â‘¨", label:"ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰",     out:"â‘¨ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰â†’",    channel:"ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰", loadName:"ãƒã‚¹ã®ã¿2DAYï¼ˆå­ä¾›ï¼‰", threshold:10, request:10 },
    { key:"t10", no:"â‘©", label:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰",     out:"â‘©ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰â†’",    channel:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰", loadName:"ã‚¯ãƒ«ãƒ¼ã‚ºã®ã¿ï¼ˆå­ä¾›ï¼‰", threshold:10, request:10 },
  ];

  // ç‰©è²©
  const GOODS = [
    { key:"g_water", label:"æ°´", unit:"æœ¬", price:200, outLine:(n)=>`æ°´x${n}æœ¬` },
    { key:"g_umb",   label:"å‚˜", unit:"æœ¬", price:500, outLine:(n)=>`å‚˜ Ã— ${n}æœ¬` },
    { key:"g_kairo", label:"ã‚«ã‚¤ãƒ­", unit:"æš", price:100, outLine:(n)=>`ã‚«ã‚¤ãƒ­x${n}æš` },
  ];

  // è¡¨ã®åˆ—
  const COLS = [
    { key:"credit", label:"ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ", money:true },
    { key:"cash",   label:"ç¾é‡‘",       money:true },
    { key:"klook",  label:"Klook",      money:false },
    { key:"nutsmeg",label:"ãƒŠãƒ„ãƒ¡ã‚°",   money:false },
    { key:"kansai", label:"é–¢è¥¿ãƒ‘ã‚¹",   money:true },
    { key:"ic",     label:"äº¤é€šç³»IC",   money:true },
  ];

  // å˜ä¾¡
  const PRICE = {
    t1: 6000, t2: 8200, t3: 4400, t4: 6600, t5: 2000,
    t6: 3300, t7: 4400, t8: 2200, t9: 3300, t10: 800,
    g_water: 200, g_umb: 500, g_kairo: 100
  };

  // é–¢è¥¿ãƒ‘ã‚¹ã®ç‰¹ä¾‹
  function unitPrice(rowKey, colKey){
    if(colKey === "kansai" && rowKey === "t3") return 2500;
    if(colKey === "kansai" && rowKey === "t8") return 1500;
    return PRICE[rowKey] ?? 0;
  }

  // çŠ¶æ…‹
  let prevInv = Object.fromEntries(TICKETS.map(t => [t.key, 0]));
  let counts = {};
  const ALL_ROWS = [
    ...TICKETS.map(t=>({key:t.key, label:`${t.no}${t.label}`, kind:"ticket"})),
    ...GOODS.map(g=>({key:g.key, label:`${g.label}`, kind:"goods"})),
  ];

  function initCounts(){
    counts = {};
    for(const r of ALL_ROWS){
      counts[r.key] = {};
      for(const c of COLS) counts[r.key][c.key] = 0;
    }
  }

  function toInt(v){
    const n = Number(String(v ?? "").trim());
    return Number.isFinite(n) && n > 0 ? Math.floor(n) : 0;
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function jpWeekday(d){ return ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()]; }

  function getJSTParts(){
    const dtf = new Intl.DateTimeFormat("ja-JP", { timeZone:"Asia/Tokyo", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", hour12:false });
    const parts = dtf.formatToParts(new Date());
    const get = (type) => parts.find(p=>p.type===type)?.value;
    return { y:+get("year"), m:+get("month"), d:+get("day"), hh:+get("hour"), mm:+get("minute") };
  }
  function initDateToJSTToday(){
    const {y,m,d} = getJSTParts();
    $("date").value = `${y}-${pad2(m)}-${pad2(d)}`;
  }
  function dateFromInput(){
    const s = $("date").value;
    if(!s){
      const {y,m,d} = getJSTParts();
      return new Date(`${y}-${pad2(m)}-${pad2(d)}T00:00:00`);
    }
    return new Date(s + "T00:00:00");
  }
  function fmtStock(d){ return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}(${jpWeekday(d)})`; }
  function fmtSales(d){ return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥(${jpWeekday(d)})`; }

  function autoDefaultBusByTime(){
    const {hh, mm} = getJSTParts();
    const isA = (hh < 17) || (hh === 17 && mm <= 30);
    return isA ? "A" : "B";
  }

  function mapWeatherCodeToJP(code){
    if(code === 0) return "æ™´ã‚Œ";
    if(code >= 1 && code <= 3) return "ãã‚‚ã‚Š";
    if(code === 45 || code === 48) return "ãã‚‚ã‚Š";
    if((code >= 51 && code <= 67) || (code >= 80 && code <= 82) || code >= 95) return "é›¨";
    if(code >= 71 && code <= 77) return "é›¨";
    return "ãã‚‚ã‚Š";
  }

  async function fetchWeatherDefault(){
    const hint = $("weatherHint");
    hint.textContent = "å¤©æ°—å–å¾—ä¸­â€¦";
    const fallback = { lat: 34.6937, lon: 135.5023, note: "ï¼ˆä½ç½®æƒ…å ±ãªã—ï¼šå¤§é˜ªå›ºå®šï¼‰" };

    const getPos = () => new Promise((resolve) => {
      if(!navigator.geolocation) return resolve(fallback);
      navigator.geolocation.getCurrentPosition(
        (pos)=>resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, note:"ï¼ˆç¾åœ¨åœ°ï¼‰" }),
        ()=>resolve(fallback),
        { enableHighAccuracy:false, timeout:3500, maximumAge: 60_000 }
      );
    });

    const {lat, lon, note} = await getPos();

    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&timezone=Asia%2FTokyo`;
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("fetch failed");
      const data = await res.json();
      const code = data?.current_weather?.weathercode;
      if(typeof code !== "number") throw new Error("no code");
      const jp = mapWeatherCodeToJP(code);

      if(!$("weather").dataset.touched){
        $("weather").value = jp;
        try{ localStorage.setItem(LS.lastWeather, jp); }catch{}
      }
      hint.textContent = `å¤©æ°—è‡ªå‹•è¨­å®šï¼š${jp} ${note}`;
    }catch{
      hint.textContent = `å¤©æ°—å–å¾—å¤±æ•—ï¼ˆæœªé¸æŠã®ã¾ã¾ï¼‰${note}`;
    }
  }

  function updateLeaderUI(){
    const bus = $("bus").value;
    if(bus === "A"){
      $("leader1Label").textContent = "A1ï¼ˆå…¥åŠ›ï¼‰";
      $("leader2Label").textContent = "A2ï¼ˆå…¥åŠ›ãƒ»ä¿å­˜ã•ã‚Œã‚‹ï¼‰";
      try{ $("leader2").value = localStorage.getItem(LS.A2) || $("leader2").value; }catch{}
    }else{
      $("leader1Label").textContent = "B1ï¼ˆå…¥åŠ›ï¼‰";
      $("leader2Label").textContent = "B2ï¼ˆå…¥åŠ›ãƒ»ä¿å­˜ã•ã‚Œã‚‹ï¼‰";
      try{ $("leader2").value = localStorage.getItem(LS.B2) || $("leader2").value; }catch{}
    }
  }
  function persistLeader2(){
    const bus = $("bus").value;
    const v = ($("leader2").value || "").trim();
    try{
      if(bus === "A") localStorage.setItem(LS.A2, v);
      else localStorage.setItem(LS.B2, v);
    }catch{}
  }
  function leaderLine(){
    const bus = $("bus").value;
    const l1 = ($("leader1").value || "").trim() || "ï¼ˆæœªå…¥åŠ›ï¼‰";
    const l2 = ($("leader2").value || "").trim() || "ï¼ˆæœªå…¥åŠ›ï¼‰";
    return bus === "A" ? `æ‹…å½“: A1${l1}ã€ A2${l2}` : `æ‹…å½“: B1${l1}ã€ B2${l2}`;
  }

  function parsePrevText(text){
    const res = { ok:true, missing:[], inv:{}, staff:"", bus:"" };
    const arrow = "(?:â†’|â‡’|â”|->|ï¼)";
    for(const t of TICKETS){
      const sym = t.no.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const re = new RegExp(sym + "[^\\n\\r]*?" + arrow + "\\s*(\\d+)", "i");
      const m = text.match(re);
      if(!m){
        res.ok = false;
        res.missing.push(t.no);
        res.inv[t.key] = 0;
      }else{
        res.inv[t.key] = toInt(m[1]);
      }
    }
    return res;
  }
  function applyParsed(parsed){
    prevInv = Object.fromEntries(TICKETS.map(t => [t.key, parsed.inv[t.key] ?? 0]));
  }
  function showParseStatus(parsed){
    if(parsed.ok){
      $("parseStatus").innerHTML = `<span class="ok">ãƒ‘ãƒ¼ã‚¹æˆåŠŸ</span>`;
    }else{
      $("parseStatus").innerHTML = `<span class="ng">ãƒ‘ãƒ¼ã‚¹ä¸€éƒ¨å¤±æ•—</span>ï¼šå–å¾—ã§ããªã„è¡Œ ${parsed.missing.join(" ")}ï¼ˆè©²å½“ã¯0æ‰±ã„ï¼‰`;
    }
  }

  async function fetchPrevInventory(){
    const statusEl = $("fetchStatus");
    if(statusEl) statusEl.textContent = "å–å¾—ä¸­â€¦";

    const date = $("date").value;
    const bus  = $("bus").value;

    if(!GAS_URL || !GAS_URL.startsWith("https://script.google.com/")){
      if(statusEl) statusEl.textContent = "GAS_URLãŒæœªè¨­å®šã§ã™ï¼ˆ/exec URLã‚’è²¼ã£ã¦ãã ã•ã„ï¼‰";
      return;
    }

    const url = `${GAS_URL}?action=getPrev&date=${encodeURIComponent(date)}&bus=${encodeURIComponent(bus)}`;

    try{
      const res = await fetch(url, { cache:"no-store" });
      const data = await res.json();

      if(!data.ok){
        if(statusEl) statusEl.textContent = `å–å¾—å¤±æ•—: ${data.error || "unknown"}`;
        return;
      }
      if(!data.found){
        if(statusEl) statusEl.textContent = "å‰å›åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆLINEè²¼ã‚Šä»˜ã‘ã§å¯¾å¿œã—ã¦ãã ã•ã„ï¼‰";
        return;
      }

      prevInv = data.inv || prevInv;
      renderInvTable();
      if(statusEl) statusEl.textContent = `å–å¾—æˆåŠŸï¼ˆ${data.source_date} / ãƒã‚¹${data.bus}ï¼‰`;
    }catch(e){
      console.error(e);
      if(statusEl) statusEl.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
    }
  }

  function buildMatrix(){
    const tb = $("matrixBody");
    tb.innerHTML = "";
    for(const r of ALL_ROWS){
      const tr = document.createElement("tr");
      const first = document.createElement("td");
      first.className = "rowTag";
      first.textContent = r.label;
      tr.appendChild(first);

      for(const c of COLS){
        const td = document.createElement("td");
        const inp = document.createElement("input");
        inp.className = "cellNum";
        inp.type = "number";
        inp.min = "0";
        inp.inputMode = "numeric";
        inp.value = "0";
        inp.addEventListener("input", () => {
          counts[r.key][c.key] = toInt(inp.value);
          recomputeFromMatrix();
          renderInvTable();
        });
        td.appendChild(inp);
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
  }

  function soldCountForTicket(ticketKey){
    let s = 0;
    for(const c of COLS) s += (counts[ticketKey]?.[c.key] ?? 0);
    return s;
  }

  function moneyTotals(){
    let credit=0, cash=0, kansai=0, ic=0, gross=0;
    let klookCount=0, nutsmegCount=0;

    for(const r of ALL_ROWS){
      klookCount += (counts[r.key]?.klook ?? 0);
      nutsmegCount += (counts[r.key]?.nutsmeg ?? 0);

      for(const colKey of ["credit","cash","kansai","ic"]){
        const n = counts[r.key]?.[colKey] ?? 0;
        if(n <= 0) continue;
        const unit = unitPrice(r.key, colKey);
        const amt = n * unit;
        gross += amt;
        if(colKey==="credit") credit += amt;
        if(colKey==="cash") cash += amt;
        if(colKey==="kansai") kansai += amt;
        if(colKey==="ic") ic += amt;
      }
    }
    return { credit, cash, kansai, ic, gross, klookCount, nutsmegCount };
  }

  function recomputeFromMatrix(){
    const { credit, cash, kansai, ic, gross, klookCount, nutsmegCount } = moneyTotals();
    const rate = Number($("taxRate").value || 10) / 100;
    const ex = Math.round(gross / (1 + rate));

    $("salesIn").value = `${gross.toLocaleString()}å††`;
    $("salesEx").value = `${ex.toLocaleString()}å††`;
    $("cashSum").value = `${cash.toLocaleString()}å††`;
    $("creditSum").value = `${credit.toLocaleString()}å††`;
    $("icSum").value = `${ic.toLocaleString()}å††`;
    $("kansaiSum").value = `${kansai.toLocaleString()}å††`;
    $("klookCount").value = `${klookCount}æš`;
    $("nutsmegCount").value = `${nutsmegCount}æš`;
  }

  function todayInvFor(ticket){
    const p = prevInv[ticket.key] ?? 0;
    const s = soldCountForTicket(ticket.key);
    const raw = p - s;
    return raw >= 0 ? raw : 0;
  }

  function renderInvTable(){
    const tbody = $("invTable");
    tbody.innerHTML = "";
    const warn = [];

    for(const t of TICKETS){
      const p = prevInv[t.key] ?? 0;
      const s = soldCountForTicket(t.key);
      const ti = todayInvFor(t);

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.no} ${t.label}</td><td>${p}</td><td>${s}</td><td>${ti}</td>`;
      tbody.appendChild(tr);

      if(s > p) warn.push(`${t.no}ï¼ˆå£²ä¸Š ${s} ãŒå‰æ—¥åœ¨åº« ${p} ã‚’è¶…éï¼‰`);
    }
    $("invWarn").textContent = warn.length ? ("è­¦å‘Š: " + warn.join(" / ") + "ï¼ˆä»Šæ—¥åœ¨åº«ã¯0ã«ä¸¸ã‚ã¾ã—ãŸï¼‰") : "";
  }

  function buildStockMessage(d){
    const bus = $("bus").value;
    const lines = [];
    lines.push(`${fmtStock(d)}ãƒã‚±ãƒƒãƒˆåœ¨åº«`);
    lines.push(`ãƒã‚¹${bus}`);
    lines.push("");
    for(const t of TICKETS){
      lines.push(`${t.out}${todayInvFor(t)}`);
    }
    lines.push("");
    lines.push(leaderLine());
    return lines.join("\n");
  }

  function buildChannelLinesFor(key){
    const lines = [];
    for(const t of TICKETS){
      const v = counts[t.key]?.[key] ?? 0;
      if(v > 0) lines.push(`${t.channel}${v}å`);
    }
    return lines;
  }

  function goodsLinesFromMatrix(){
    const out = [];
    for(const g of GOODS){
      const total = COLS.reduce((a,c)=>a + (counts[g.key]?.[c.key] ?? 0), 0);
      if(total > 0) out.push(g.outLine(total));
    }
    return out;
  }

  function buildSalesMessage(d){
    const bus = $("bus").value;
    const weather = $("weather").value || "ï¼ˆæœªå…¥åŠ›ï¼‰";
    const { credit, cash, ic, gross } = moneyTotals();
    const rate = Number($("taxRate").value || 10) / 100;
    const ex = Math.round(gross / (1 + rate));

    const klookLines = buildChannelLinesFor("klook");
    const nutsmegLines = buildChannelLinesFor("nutsmeg");
    const kansaiLines = buildChannelLinesFor("kansai");
    const goodsLines = goodsLinesFromMatrix();

    const lines = [];
    lines.push(`${fmtSales(d)}`);
    lines.push(`ãƒã‚¹${bus}`);
    lines.push(leaderLine());
    lines.push(`å¤©æ°—:  ${weather}`);
    lines.push("");
    lines.push(`å£²ä¸Š ${ex.toLocaleString()}å††ï¼ˆç¨åˆ¥ï¼‰`);
    lines.push(`   ${gross.toLocaleString()}å††ï¼ˆç¨è¾¼ï¼‰`);
    lines.push("");
    lines.push(`ã€ç¾é‡‘åˆè¨ˆã€‘${cash.toLocaleString()}å††`);
    lines.push(`ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆåˆè¨ˆã€‘${credit.toLocaleString()}å††`);
    lines.push(`ã€äº¤é€šç³»åˆè¨ˆã€‘${ic.toLocaleString()}å††`);
    lines.push(`ã€é–¢è¥¿ãƒ‘ã‚¹åˆè¨ˆã€‘${moneyTotals().kansai.toLocaleString()}å††`);

    lines.push(`ã€klookã€‘`);
    if(klookLines.length) lines.push(...klookLines);
    lines.push(`ã€ãƒŠãƒ„ãƒ¡ã‚°ã€‘`);
    if(nutsmegLines.length) lines.push(...nutsmegLines);
    lines.push(`ã€é–¢è¥¿ãƒ‘ã‚¹ã€‘`);
    if(kansaiLines.length) lines.push(...kansaiLines);

    if(goodsLines.length){
      lines.push("");
      lines.push(...goodsLines);
    }

    return lines.join("\n");
  }

  function parseMentions(text){
    const raw = (text || "").trim();
    if(!raw) return [];
    return raw.split(/[\n\r\s]+/).map(s=>s.trim()).filter(Boolean);
  }

  function buildLoadRequestMessage(){
    const bus = $("bus").value;

    const needed = [];
    for(const t of TICKETS){
      const inv = todayInvFor(t);
      if(inv <= t.threshold) needed.push(`${t.loadName}x${t.request}`);
    }

    const extras = ($("extraLoad").value || "").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!needed.length && !extras.length) return "";

    const mentions = parseMentions($("mentions").value);
    const lines = [];
    if(mentions.length) lines.push(...mentions);
    lines.push("");
    lines.push("ãŠç–²ã‚Œæ§˜ã§ã™ï¼");
    lines.push("ä¸‹è¨˜ç©è¾¼ã¿ãŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼");
    lines.push("");
    lines.push("ã€ç©è¾¼ä¾é ¼ã€‘");
    lines.push(`ãƒã‚¹${bus}`);
    if(needed.length) lines.push(...needed);
    if(extras.length) lines.push(...extras);
    return lines.join("\n");
  }

  function setOutput(text){ $("out").value = text; }

  async function copyOutput(){
    const text = $("out").value || "";
    if(!text.trim()) return;
    try{
      await navigator.clipboard.writeText(text);
      $("copyStatus").style.display = "block";
      setTimeout(()=> $("copyStatus").style.display="none", 1200);
    }catch{
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
    }
  }

  function buildClientId(){
    try{
      let id = localStorage.getItem(LS.clientId);
      if(!id){
        id = "c_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem(LS.clientId, id);
      }
      return id;
    }catch{
      return "";
    }
  }

  function buildPayloadForSave(){
    const date = $("date").value;
    const bus  = $("bus").value;

    // inv payload
    const invObj = {};
    for(const t of TICKETS){
      invObj[t.key] = {
        prev: prevInv[t.key] ?? 0,
        sold: soldCountForTicket(t.key),
        today: todayInvFor(t)
      };
    }

    // matrix payload
    const matrixObj = {};
    for(const r of ALL_ROWS){
      matrixObj[r.key] = {};
      for(const c of COLS){
        matrixObj[r.key][c.key] = counts[r.key]?.[c.key] ?? 0;
      }
    }

    const totals = moneyTotals();
    const rate = Number($("taxRate").value || 10) / 100;
    const ex = Math.round((totals.gross || 0) / (1 + rate));
    const loadText = buildLoadRequestMessage();
    const outAll = $("out").value || "";

    return {
      action: "saveReport",
      date, bus,
      meta: {
        weather: $("weather").value || "",
        leader1: ($("leader1").value || "").trim(),
        leader2: ($("leader2").value || "").trim(),
        loadText,
        outAll,
        clientId: buildClientId()
      },
      totals: {
        gross: totals.gross || 0,
        ex,
        cash: totals.cash || 0,
        credit: totals.credit || 0,
        ic: totals.ic || 0,
        kansai: totals.kansai || 0,
        klookCount: totals.klookCount || 0,
        nutsmegCount: totals.nutsmegCount || 0
      },
      inv: invObj,
      matrix: matrixObj
    };
  }

  async function saveToSheet(){
    const st = $("saveStatus");
    if(st) st.textContent = "ä¿å­˜ä¸­â€¦";

    if(!GAS_URL || !GAS_URL.startsWith("https://script.google.com/")){
      if(st) st.textContent = "GAS_URLãŒæœªè¨­å®šã§ã™ï¼ˆ/exec URLã‚’è²¼ã£ã¦ãã ã•ã„ï¼‰";
      return;
    }

    // å‡ºåŠ›ãŒç©ºãªã‚‰è‡ªå‹•ç”Ÿæˆã—ã¦ä¿å­˜
    if(!($("out").value || "").trim()){
      $("genAll").click();
    }

    const payload = buildPayloadForSave();

    try{
      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!data.ok){
        if(st) st.textContent = `ä¿å­˜å¤±æ•—: ${data.error || "unknown"}`;
        return;
      }
      if(st) st.textContent = "ä¿å­˜OK";
    }catch(e){
      console.error(e);
      if(st) st.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
    }
  }

  // ===== Calendar =====
  const DOW = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  let calYear, calMonth; // 1-12

  function ymd(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }

  function setCalToNow(){
    const now = new Date();
    calYear = now.getFullYear();
    calMonth = now.getMonth()+1;
  }

  function renderDow(){
    const grid = $("calGrid");
    grid.innerHTML = "";
    for(const w of DOW){
      const div = document.createElement("div");
      div.className = "calDow";
      div.textContent = w;
      grid.appendChild(div);
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function openModal(title, html){
    $("dayModalTitle").textContent = title;
    $("dayModalBody").innerHTML = html;
    $("dayModal").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    $("dayModal").setAttribute("aria-hidden","true");
  }

  async function loadCalendar(){
    const st = $("calStatus");
    if(st) st.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";

    const bus = $("calBus").value;
    const year = calYear;
    const month = pad2(calMonth);

    $("monthTitle").textContent = `${year}å¹´ ${calMonth}æœˆï¼ˆãƒã‚¹${bus}ï¼‰`;

    const url = `${GAS_URL}?action=getMonth&year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)}&bus=${encodeURIComponent(bus)}`;

    try{
      const res = await fetch(url, { cache:"no-store" });
      const data = await res.json();
      if(!data.ok){
        if(st) st.textContent = `å¤±æ•—: ${data.error || "unknown"}`;
        return;
      }
      const days = data.days || {};
      buildCalendarGrid_(year, calMonth, bus, days);
      if(st) st.textContent = "OKï¼ˆæ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ãŒå‡ºã¾ã™ï¼‰";
    }catch(e){
      console.error(e);
      if(st) st.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼";
    }
  }

  function buildCalendarGrid_(year, month, bus, dayToGross){
    renderDow();
    const grid = $("calGrid");

    const first = new Date(year, month-1, 1);
    const last  = new Date(year, month, 0);
    const firstDow = first.getDay();
    const lastDate = last.getDate();

    for(let i=0;i<firstDow;i++){
      const div = document.createElement("div");
      div.className = "calCell calEmpty";
      grid.appendChild(div);
    }

    for(let d=1; d<=lastDate; d++){
      const dateStr = ymd(year, month, d);
      const gross = Number(dayToGross?.[dateStr] ?? 0);

      const cell = document.createElement("div");
      cell.className = "calCell";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.addEventListener("click", ()=> loadDayDetail(dateStr, bus));

      const top = document.createElement("div");
      top.className = "calDate";
      top.textContent = String(d);
      btn.appendChild(top);

      if(gross > 0){
        const money = document.createElement("div");
        money.className = "calMoney";
        money.textContent = `å£²ä¸Š: Â¥${gross.toLocaleString()}`;
        btn.appendChild(money);
      }else{
        const small = document.createElement("div");
        small.className = "small";
        small.style.marginTop = "6px";
        small.textContent = "ãƒ‡ãƒ¼ã‚¿ãªã—";
        btn.appendChild(small);
      }

      cell.appendChild(btn);
      grid.appendChild(cell);
    }
  }

  async function loadDayDetail(dateStr, bus){
    const url = `${GAS_URL}?action=getDay&date=${encodeURIComponent(dateStr)}&bus=${encodeURIComponent(bus)}`;
    openModal(`${dateStr}ï¼ˆãƒã‚¹${bus}ï¼‰`, "èª­ã¿è¾¼ã¿ä¸­â€¦");

    try{
      const res = await fetch(url, { cache:"no-store" });
      const data = await res.json();
      if(!data.ok){
        openModal(`${dateStr}ï¼ˆãƒã‚¹${bus}ï¼‰`, `å–å¾—å¤±æ•—: ${data.error || "unknown"}`);
        return;
      }
      if(!data.found || !data.report){
        openModal(`${dateStr}ï¼ˆãƒã‚¹${bus}ï¼‰`, "ã“ã®æ—¥ä»˜ã®ãƒ¬ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      const r = data.report;
      const inv = data.inventory || {};
      const keys = Object.keys(inv).sort();

      const invHtml = keys.length
        ? `<table>
            <thead><tr><th>ticket_key</th><th>æ®‹æ•°</th></tr></thead>
            <tbody>
              ${keys.map(k=>`<tr><td>${escapeHtml(k)}</td><td>${Number(inv[k]||0)}</td></tr>`).join("")}
            </tbody>
          </table>`
        : `<div class="small">åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãªã—</div>`;

      const html = `
        <div class="small">
          <div><b>å¤©æ°—</b>: ${escapeHtml(r.weather||"")}</div>
          <div><b>ãƒªãƒ¼ãƒ€ãƒ¼</b>: ${escapeHtml(r.leader1||"")} / ${escapeHtml(r.leader2||"")}</div>
          <div class="divider"></div>
          <div><b>å£²ä¸Šï¼ˆç¨è¾¼ï¼‰</b>: Â¥${Number(r.gross||0).toLocaleString()}</div>
          <div><b>ç¾é‡‘</b>: Â¥${Number(r.cash||0).toLocaleString()}</div>
          <div><b>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</b>: Â¥${Number(r.credit||0).toLocaleString()}</div>
          <div><b>IC</b>: Â¥${Number(r.ic||0).toLocaleString()}</div>
          <div><b>é–¢è¥¿å‘¨éŠ</b>: Â¥${Number(r.kansai||0).toLocaleString()}</div>
          <div><b>Klook</b>: ${Number(r.klookCount||0)} ä»¶</div>
          <div><b>Nutsmeg</b>: ${Number(r.nutsmegCount||0)} ä»¶</div>
          <div class="divider"></div>
          <div style="font-weight:700;">åœ¨åº«ï¼ˆä»Šæ—¥æ®‹ï¼‰</div>
          ${invHtml}
        </div>
      `;
      openModal(`${dateStr}ï¼ˆãƒã‚¹${bus}ï¼‰`, html);
    }catch(e){
      console.error(e);
      openModal(`${dateStr}ï¼ˆãƒã‚¹${bus}ï¼‰`, "é€šä¿¡ã‚¨ãƒ©ãƒ¼");
    }
  }

  // ===== events =====
  $("taxRate").addEventListener("input", () => recomputeFromMatrix());

  $("parseBtn").addEventListener("click", (e) => {
    e.preventDefault();
    const text = $("prevPaste").value || "";
    const parsed = parsePrevText(text);
    applyParsed(parsed);
    showParseStatus(parsed);
    renderInvTable();
  });

  $("clearPrevBtn").addEventListener("click", (e) => {
    e.preventDefault();
    $("prevPaste").value = "";
    $("parseStatus").textContent = "";
    prevInv = Object.fromEntries(TICKETS.map(t => [t.key, 0]));
    renderInvTable();
  });

  $("prevPaste").addEventListener("input", () => {
    const text = $("prevPaste").value || "";
    if(text.trim().length < 10) return;
    const parsed = parsePrevText(text);
    applyParsed(parsed);
    showParseStatus(parsed);
    renderInvTable();
  });

  $("fetchPrevBtn").addEventListener("click", (e) => {
    e.preventDefault();
    fetchPrevInventory();
  });

  $("genInv").addEventListener("click", (e) => {
    e.preventDefault();
    setOutput(buildStockMessage(dateFromInput()));
  });

  $("genSales").addEventListener("click", (e) => {
    e.preventDefault();
    setOutput(buildSalesMessage(dateFromInput()));
  });

  $("genAll").addEventListener("click", (e) => {
    e.preventDefault();
    const d = dateFromInput();
    const stock = buildStockMessage(d);
    const sales = buildSalesMessage(d);
    const load = buildLoadRequestMessage();
    setOutput(load ? (stock + "\n\n" + sales + "\n\n" + load) : (stock + "\n\n" + sales));
  });

  $("copy").addEventListener("click", async (e) => {
    e.preventDefault();
    if(!($("out").value || "").trim()) $("genAll").click();
    await copyOutput();
  });

  $("saveToSheet").addEventListener("click", async (e) => {
    e.preventDefault();
    await saveToSheet();
  });

  $("refreshCalAfterSave").addEventListener("click", async (e) => {
    e.preventDefault();
    await saveToSheet();
    // è¡¨ç¤ºãƒã‚¹ã‚’å…¥åŠ›ãƒã‚¹ã«æƒãˆã‚‹ï¼ˆå¥½ã¿ã§å‰Šé™¤OKï¼‰
    $("calBus").value = $("bus").value;
    await loadCalendar();
  });

  $("bus").addEventListener("change", () => {
    updateLeaderUI();
    try{ localStorage.setItem(LS.lastBus, $("bus").value); }catch{}
  });

  $("leader2").addEventListener("input", () => persistLeader2());
  $("weather").addEventListener("change", () => {
    $("weather").dataset.touched = "1";
    try{ localStorage.setItem(LS.lastWeather, $("weather").value);}catch{}
  });

  // calendar controls
  $("prevMonth").addEventListener("click",(e)=>{
    e.preventDefault();
    calMonth--;
    if(calMonth<=0){ calMonth=12; calYear--; }
    loadCalendar();
  });
  $("nextMonth").addEventListener("click",(e)=>{
    e.preventDefault();
    calMonth++;
    if(calMonth>=13){ calMonth=1; calYear++; }
    loadCalendar();
  });
  $("reloadCal").addEventListener("click",(e)=>{
    e.preventDefault();
    loadCalendar();
  });
  $("calBus").addEventListener("change", ()=> loadCalendar());

  $("closeModal").addEventListener("click",(e)=>{
    e.preventDefault();
    closeModal();
  });
  $("dayModal").addEventListener("click",(e)=>{
    if(e.target && e.target.id==="dayModal") closeModal();
  });

  // ===== init =====
  function initBusDefault(){
    let chosen = "";
    try{ chosen = localStorage.getItem(LS.lastBus) || ""; }catch{}
    if(chosen !== "A" && chosen !== "B"){
      chosen = autoDefaultBusByTime();
      $("busAutoHint").textContent = `æ™‚åˆ»(JST)ã«ã‚ˆã‚ŠåˆæœŸå€¤ï¼šãƒã‚¹${chosen}`;
    }else{
      $("busAutoHint").textContent = `å‰å›é¸æŠã‚’å¾©å…ƒï¼šãƒã‚¹${chosen}`;
    }
    $("bus").value = chosen;
  }

  function initWeatherDefault(){
    let chosen = "";
    try{ chosen = localStorage.getItem(LS.lastWeather) || ""; }catch{}
    if(chosen && !$("weather").dataset.touched){
      $("weather").value = chosen;
      $("weatherHint").textContent = `å‰å›é¸æŠã‚’å¾©å…ƒï¼š${chosen}`;
    }
    fetchWeatherDefault();
  }

  initCounts();
  buildMatrix();
  initDateToJSTToday();
  initBusDefault();
  updateLeaderUI();
  initWeatherDefault();
  recomputeFromMatrix();
  renderInvTable();

  // calendar init
  setCalToNow();
  $("calBus").value = $("bus").value;
  loadCalendar();
})();
</script>

</body>
</html>